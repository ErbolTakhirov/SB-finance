{% extends 'base.html' %}
{% block title %}–î–∞—à–±–æ—Ä–¥{% endblock %}
{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-0">üìä –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –î–∞—à–±–æ—Ä–¥</h2>
    <div class="muted">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ AI-–∏–Ω—Å–∞–π—Ç—ã</div>
  </div>
  <form method="get" class="d-flex align-items-center gap-2" id="filterForm">
    <label class="d-inline-flex align-items-center gap-2">–°:
      <input class="form-control form-control-sm" type="date" name="start" id="dateStart" value="{{ start|default:'' }}">
    </label>
    <label class="d-inline-flex align-items-center gap-2">–ü–æ:
      <input class="form-control form-control-sm" type="date" name="end" id="dateEnd" value="{{ end|default:'' }}">
    </label>
    <button class="btn btn-primary btn-sm" type="submit"><i class="bi bi-funnel"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    <a class="btn btn-outline-secondary btn-sm" href="/dashboard/"><i class="bi bi-arrow-counterclockwise"></i> –°–±—Ä–æ—Å</a>
  </form>
</div>

<div id="processBanner" class="alert alert-info d-none fade-in" role="alert">
  <div class="loader-inline">
    <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
    <span id="processBannerText">–§–∞–π–ª –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è‚Ä¶</span>
  </div>
  <span class="ms-2 soft-badge" id="processSubstate" style="display:none;"></span>
  <button type="button" class="btn-close float-end" aria-label="Close" onclick="document.getElementById('processBanner').classList.add('d-none')"></button>
</div>

<!-- KPI Cards -->
<div class="kpi mb-5">
  <div class="kpi-card income">
    <div class="label">üí∞ –î–æ—Ö–æ–¥—ã</div>
    <div class="value text-success" id="kpi-income">{{ income_total|default:0 }}</div>
    <div class="small muted mt-2" id="kpi-income-change"></div>
  </div>
  <div class="kpi-card expense">
    <div class="label">üí∏ –†–∞—Å—Ö–æ–¥—ã</div>
    <div class="value text-danger" id="kpi-expense">{{ expense_total|default:0 }}</div>
    <div class="small muted mt-2" id="kpi-expense-change"></div>
  </div>
  <div class="kpi-card profit">
    <div class="label">üìà –ü—Ä–∏–±—ã–ª—å</div>
    <div class="value text-primary" id="kpi-profit">{{ profit|default:0 }}</div>
    <div class="small muted mt-2" id="kpi-profit-change"></div>
    <div id="ai-kpi" class="mt-2"></div>
  </div>
</div>

<!-- Real Data Charts Container -->
<div id="chartsContainer" class="mb-4">
  <!-- Charts built from real DB data will be rendered here -->
</div>

<!-- AI Insights -->
<div class="row mb-3">
  <div class="col-md-6 mb-3">
    <div class="app-card p-3 h-100">
      <div class="app-section-title mb-2">üö© AI –û–ø–æ–≤–µ—â–µ–Ω–∏—è</div>
      <ul id="ai-alerts" class="mb-0 small"></ul>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="app-card p-3 h-100">
      <div class="app-section-title mb-2">üí° AI –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
      <ul id="ai-recs" class="mb-0 small"></ul>
    </div>
  </div>
</div>

<!-- Upload File -->
<div class="app-card p-4 mb-3">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <div>
      <div class="app-section-title mb-1">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</div>
      <div class="muted small">CSV ¬∑ DOCX ¬∑ PDF</div>
    </div>
  </div>
  <form method="post" enctype="multipart/form-data" class="mt-3" id="uploadForm">{% csrf_token %}
    <div class="d-flex flex-wrap gap-3 align-items-end mb-3">
      <div style="flex: 1; min-width: 280px;">
        <label class="form-label small fw-semibold mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
        <input class="form-control" type="file" name="upload_file" accept=".csv,.pdf,.docx" required id="fileInput">
      </div>
      <div class="form-check d-flex align-items-center" style="min-height: 40px;">
        <input class="form-check-input" type="checkbox" name="import_to_db" id="import_to_db" checked>
        <label class="form-check-label ms-2" for="import_to_db">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ CSV –≤ –±–∞–∑—É</label>
      </div>
      <button class="btn btn-success" type="submit" id="uploadBtn">
        <i class="bi bi-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
      </button>
    </div>
    <div id="uploadProgress" class="d-none">
      <div class="progress" style="height: 8px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="progressBar"></div>
      </div>
      <div class="mt-2 small muted" id="progressText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ...</div>
    </div>
  </form>
</div>

<!-- Records Feed -->
<div class="app-card p-3">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
    <div class="app-section-title mb-0">üìã –õ–µ–Ω—Ç–∞ –∑–∞–ø–∏—Å–µ–π</div>
    <div class="actions">
      <label class="form-check d-inline-flex align-items-center gap-2"><input class="form-check-input flt-type" type="checkbox" value="income" checked> –î–æ—Ö–æ–¥—ã</label>
      <label class="form-check d-inline-flex align-items-center gap-2"><input class="form-check-input flt-type" type="checkbox" value="expense" checked> –†–∞—Å—Ö–æ–¥—ã</label>
      <input class="form-control" style="max-width: 220px;" type="text" id="search" placeholder="–ü–æ–∏—Å–∫">
      <button class="btn btn-outline-primary" id="reload" type="button"><i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </div>
  <ul id="feed" class="mb-0"></ul>
</div>

<!-- Chart.js for real data charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// Real data charts state
let dashboardData = null;
let renderedCharts = {};
let hasData = false;

// Color palette for charts
const CHART_COLORS = {
  income: '#34A853',
  expense: '#FF6363',
  profit: '#3B82F6',
  balance: '#8B5CF6',
  anomaly: '#7EE787',
  category: ['#FF6363', '#3B82F6', '#34A853', '#F59E0B', '#8B5CF6', '#10B981', '#EF4444', '#06B6D4', '#6366F1', '#EC4899']
};

function themeVars() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  const root = getComputedStyle(document.documentElement);
  return {
    text: root.getPropertyValue('--ink-900').trim() || (isDark ? '#ECECEC' : '#0f172a'),
    grid: root.getPropertyValue('--grid-color').trim() || (isDark ? 'rgba(255,255,255,0.06)' : 'rgba(15,23,42,0.06)'),
    bg: root.getPropertyValue('--bg-elev').trim() || (isDark ? '#0D0D0D' : '#ffffff'),
    border: root.getPropertyValue('--border').trim() || (isDark ? 'rgba(255,255,255,0.1)' : 'rgba(15,23,42,0.08)'),
    hoverBg: root.getPropertyValue('--bg-hover').trim() || (isDark ? '#1A1A1A' : '#F8F9FA'),
  };
}

function setProcessing(on, text='–§–∞–π–ª –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è‚Ä¶', sub='') {
  const banner = document.getElementById('processBanner');
  const txt = document.getElementById('processBannerText');
  const subEl = document.getElementById('processSubstate');
  if (on) {
    txt.textContent = text;
    banner.classList.remove('d-none');
    if (sub) {
      subEl.textContent = sub;
      subEl.style.display = '';
    } else {
      subEl.style.display = 'none';
    }
  } else {
    banner.classList.add('d-none');
  }
}

// Render charts from real DB data
function renderChartsFromDB(data) {
  if (!data || !data.ok) {
    showEmptyState('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ');
    return;
  }
  
  dashboardData = data;
  hasData = true;
  const container = document.getElementById('chartsContainer');
  container.innerHTML = '';
  
  // Destroy existing charts
  Object.values(renderedCharts).forEach(chart => {
    if (chart && typeof chart.destroy === 'function') chart.destroy();
  });
  renderedCharts = {};
  
  const daily = data.daily || {};
  const categories = data.categories || {};
  const hasDailyData = daily.dates && daily.dates.length > 0;
  const hasCategoryData = (categories.expenses && categories.expenses.length > 0) || 
                          (categories.incomes && categories.incomes.length > 0);
  
  if (!hasDailyData && !hasCategoryData) {
    showEmptyState('–î–æ–±–∞–≤—å—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏');
    return;
  }
  
  // Render Time Series Chart (Primary - full width)
  if (hasDailyData) {
    const timeSeriesCard = createChartCardElement({
      id: 'timeSeries',
      title: '–î–∏–Ω–∞–º–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤',
      subtitle: '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏',
      type: 'line',
      size: 'primary'
    });
    container.appendChild(timeSeriesCard);
    // Wait for DOM to render
    setTimeout(() => renderTimeSeriesChart(daily, 'timeSeries'), 100);
  }
  
  // Render Category Charts (Secondary - grid)
  if (hasCategoryData) {
    const categoryRow = document.createElement('div');
    categoryRow.className = 'row g-4 mt-4';
    
    if (categories.expenses && categories.expenses.length > 0) {
      const expenseCol = document.createElement('div');
      expenseCol.className = 'col-md-6';
      expenseCol.appendChild(createChartCardElement({
        id: 'expenseCategories',
        title: '–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º',
        subtitle: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤',
        type: 'pie',
        size: 'secondary'
      }));
      categoryRow.appendChild(expenseCol);
      setTimeout(() => renderCategoryPieChart(categories.expenses, 'expenseCategories', 'expense'), 100);
    }
    
    if (categories.incomes && categories.incomes.length > 0) {
      const incomeCol = document.createElement('div');
      incomeCol.className = 'col-md-6';
      incomeCol.appendChild(createChartCardElement({
        id: 'incomeCategories',
        title: '–î–æ—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º',
        subtitle: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–æ–≤',
        type: 'pie',
        size: 'secondary'
      }));
      categoryRow.appendChild(incomeCol);
      setTimeout(() => renderCategoryPieChart(categories.incomes, 'incomeCategories', 'income'), 100);
    }
    
    if (categoryRow.children.length > 0) {
      container.appendChild(categoryRow);
    }
  }
  
  // Render Cumulative Chart if we have daily data
  if (hasDailyData && daily.cumulative_income && daily.cumulative_income.length > 0) {
    const cumulativeCard = createChartCardElement({
      id: 'cumulative',
      title: '–ö—É–º—É–ª—è—Ç–∏–≤–Ω—ã–π —Ä–æ—Å—Ç',
      subtitle: '–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–æ—Ö–æ–¥–æ–≤ –∏ –ø—Ä–∏–±—ã–ª–∏',
      type: 'line',
      size: 'secondary'
    });
    const cumulativeRow = document.createElement('div');
    cumulativeRow.className = 'row g-4 mt-4';
    const cumulativeCol = document.createElement('div');
    cumulativeCol.className = 'col-12';
    cumulativeCol.appendChild(cumulativeCard);
    cumulativeRow.appendChild(cumulativeCol);
    container.appendChild(cumulativeRow);
    setTimeout(() => renderCumulativeChart(daily, 'cumulative'), 100);
  }
}

// Show empty state (only if truly no data)
function showEmptyState(message) {
  const container = document.getElementById('chartsContainer');
  container.innerHTML = `
    <div class="app-card p-5 text-center">
      <div class="mb-4">
        <i class="bi bi-graph-up" style="font-size: 4rem; color: var(--ink-300);"></i>
      </div>
      <h4 class="mb-2" style="color: var(--ink-700);">${message}</h4>
      <p class="muted">–î–æ–±–∞–≤—å—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏.</p>
    </div>
  `;
  hasData = false;
}

// Create chart card element (clean ChatGPT/Stripe style)
function createChartCardElement({id, title, subtitle, type, size = 'secondary'}) {
  const card = document.createElement('div');
  card.className = 'app-card position-relative';
  card.setAttribute('data-chart-id', id);
  
  const isPrimary = size === 'primary';
  const chartHeight = isPrimary ? '450px' : '380px';
  
  const icons = {
    'line': 'bi-graph-up-arrow',
    'area': 'bi-graph-up',
    'bar': 'bi-bar-chart',
    'pie': 'bi-pie-chart',
    'scatter': 'bi-scatter'
  };
  const icon = icons[type] || 'bi-graph-up';
  
  card.innerHTML = `
    <div class="d-flex justify-content-between align-items-start mb-4">
      <div style="flex: 1;">
        <h4 class="mb-1" style="font-weight: 700; font-size: ${isPrimary ? '1.5rem' : '1.25rem'}; letter-spacing: -0.01em; color: var(--ink-900);">
          <i class="bi ${icon}" style="color: var(--brand); margin-right: 10px;"></i>
          ${title}
        </h4>
        ${subtitle ? `<p class="muted small mb-0 mt-1">${subtitle}</p>` : ''}
      </div>
      <div class="chart-export-buttons" style="opacity: 0; transition: opacity 0.2s;">
        <button class="btn btn-sm btn-outline-secondary" onclick="exportChartPNG('${id}')" title="–≠–∫—Å–ø–æ—Ä—Ç PNG">
          <i class="bi bi-download"></i>
        </button>
        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="exportChartCSV('${id}')" title="–≠–∫—Å–ø–æ—Ä—Ç CSV">
          <i class="bi bi-file-earmark-spreadsheet"></i>
        </button>
      </div>
    </div>
    <div class="chart-container" style="position: relative; height: ${chartHeight};">
      <canvas id="${id}"></canvas>
    </div>
  `;
  
  // Show export buttons on hover
  card.addEventListener('mouseenter', () => {
    const btn = card.querySelector('.chart-export-buttons');
    if (btn) btn.style.opacity = '1';
  });
  card.addEventListener('mouseleave', () => {
    const btn = card.querySelector('.chart-export-buttons');
    if (btn) btn.style.opacity = '0';
  });
  
  return card;
}

// Render Time Series Chart from real DB data
function renderTimeSeriesChart(daily, canvasId) {
  const canvas = document.getElementById(canvasId);
  if (!canvas || !daily.dates || daily.dates.length === 0) return;
  
  const tv = themeVars();
  const dates = daily.dates.map(d => {
    const date = new Date(d);
    return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
  });
  
  const datasets = [];
  
  if (daily.income && daily.income.some(v => Math.abs(v) > 0.01)) {
    datasets.push({
      label: '–î–æ—Ö–æ–¥—ã',
      data: daily.income,
      borderColor: CHART_COLORS.income,
      backgroundColor: CHART_COLORS.income + '20',
      borderWidth: 3,
      fill: false,
      tension: 0.4,
      pointRadius: 0,
      pointHoverRadius: 6,
    });
  }
  
  if (daily.expense && daily.expense.some(v => Math.abs(v) > 0.01)) {
    datasets.push({
      label: '–†–∞—Å—Ö–æ–¥—ã',
      data: daily.expense,
      borderColor: CHART_COLORS.expense,
      backgroundColor: CHART_COLORS.expense + '20',
      borderWidth: 3,
      fill: false,
      tension: 0.4,
      pointRadius: 0,
      pointHoverRadius: 6,
    });
  }
  
  if (daily.profit && daily.profit.some(v => Math.abs(v) > 0.01)) {
    datasets.push({
      label: '–ü—Ä–∏–±—ã–ª—å',
      data: daily.profit,
      borderColor: CHART_COLORS.profit,
      backgroundColor: CHART_COLORS.profit + '15',
      borderWidth: 2,
      fill: true,
      tension: 0.4,
      pointRadius: 0,
      pointHoverRadius: 5,
    });
  }
  
  const chart = new Chart(canvas, {
    type: 'line',
    data: { labels: dates, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          position: 'top',
          labels: {
            color: tv.text,
            font: { size: 13, family: 'Inter, system-ui, sans-serif', weight: '500' },
            padding: 15,
            usePointStyle: true,
          }
        },
        tooltip: {
          backgroundColor: tv.bg,
          titleColor: tv.text,
          bodyColor: tv.text,
          borderColor: tv.border,
          borderWidth: 1,
          padding: 12,
          titleFont: { size: 13, weight: '600' },
          bodyFont: { size: 12 },
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + context.parsed.y.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' —Ä—É–±.';
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: tv.text, font: { size: 11 } },
          grid: { color: tv.grid, drawBorder: false }
        },
        y: {
          ticks: { 
            color: tv.text, 
            font: { size: 11 },
            callback: function(value) {
              return value.toLocaleString('ru-RU') + ' ‚ÇΩ';
            }
          },
          grid: { color: tv.grid, drawBorder: false }
        }
      }
    }
  });
  
  renderedCharts['timeSeries'] = chart;
}

// Render Category Pie Chart from real DB data
function renderCategoryPieChart(categoryData, canvasId, type) {
  const canvas = document.getElementById(canvasId);
  if (!canvas || !categoryData || categoryData.length === 0) return;
  
  const tv = themeVars();
  const labels = categoryData.map(c => c.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
  const values = categoryData.map(c => parseFloat(c.total) || 0);
  
  // Use appropriate colors
  const baseColor = type === 'expense' ? CHART_COLORS.expense : CHART_COLORS.income;
  const colors = CHART_COLORS.category.slice(0, labels.length);
  
  const chart = new Chart(canvas, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: colors,
        borderColor: tv.bg,
        borderWidth: 2,
        hoverOffset: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: {
            color: tv.text,
            font: { size: 12, family: 'Inter, system-ui, sans-serif' },
            padding: 12,
            usePointStyle: true,
          }
        },
        tooltip: {
          backgroundColor: tv.bg,
          titleColor: tv.text,
          bodyColor: tv.text,
          borderColor: tv.border,
          borderWidth: 1,
          padding: 12,
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((value / total) * 100).toFixed(1);
              return label + ': ' + value.toLocaleString('ru-RU', { minimumFractionDigits: 2 }) + ' —Ä—É–±. (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
  
  renderedCharts[canvasId.replace('chart-', '')] = chart;
}

// Render Cumulative Chart from real DB data
function renderCumulativeChart(daily, canvasId) {
  const canvas = document.getElementById(canvasId);
  if (!canvas || !daily.dates || daily.dates.length === 0) return;
  
  const tv = themeVars();
  const dates = daily.dates.map(d => {
    const date = new Date(d);
    return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
  });
  
  const datasets = [];
  
  if (daily.cumulative_income && daily.cumulative_income.some(v => Math.abs(v) > 0.01)) {
    datasets.push({
      label: '–ö—É–º—É–ª—è—Ç–∏–≤–Ω—ã–µ –¥–æ—Ö–æ–¥—ã',
      data: daily.cumulative_income,
      borderColor: CHART_COLORS.income,
      backgroundColor: CHART_COLORS.income + '25',
      borderWidth: 3,
      fill: true,
      tension: 0.4,
    });
  }
  
  if (daily.cumulative_profit && daily.cumulative_profit.some(v => Math.abs(v) > 0.01)) {
    datasets.push({
      label: '–ö—É–º—É–ª—è—Ç–∏–≤–Ω–∞—è –ø—Ä–∏–±—ã–ª—å',
      data: daily.cumulative_profit,
      borderColor: CHART_COLORS.profit,
      backgroundColor: CHART_COLORS.profit + '25',
      borderWidth: 3,
      fill: true,
      tension: 0.4,
    });
  }
  
  if (datasets.length === 0) return;
  
  const chart = new Chart(canvas, {
    type: 'line',
    data: { labels: dates, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          position: 'top',
          labels: {
            color: tv.text,
            font: { size: 13, family: 'Inter, system-ui, sans-serif', weight: '500' },
            padding: 15,
            usePointStyle: true,
          }
        },
        tooltip: {
          backgroundColor: tv.bg,
          titleColor: tv.text,
          bodyColor: tv.text,
          borderColor: tv.border,
          borderWidth: 1,
          padding: 12,
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + context.parsed.y.toLocaleString('ru-RU', { minimumFractionDigits: 2 }) + ' —Ä—É–±.';
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: tv.text, font: { size: 11 } },
          grid: { color: tv.grid, drawBorder: false }
        },
        y: {
          ticks: { 
            color: tv.text, 
            font: { size: 11 },
            callback: function(value) {
              return value.toLocaleString('ru-RU') + ' ‚ÇΩ';
            }
          },
          grid: { color: tv.grid, drawBorder: false }
        }
      }
    }
  });
  
  renderedCharts['cumulative'] = chart;
}

// Export functions
function exportChartPNG(chartId) {
  const chart = renderedCharts[chartId];
  if (!chart) return;
  const url = chart.toBase64Image();
  const link = document.createElement('a');
  link.href = url;
  link.download = `chart-${chartId}-${new Date().toISOString().split('T')[0]}.png`;
  link.click();
}

function exportChartCSV(chartId) {
  const chart = renderedCharts[chartId];
  if (!chart || !chart.data) return;
  
  let csv = '';
  if (chart.data.labels && chart.data.datasets) {
    csv = 'Label,' + chart.data.datasets.map(d => d.label || 'Value').join(',') + '\n';
    chart.data.labels.forEach((label, idx) => {
      csv += label + ',' + chart.data.datasets.map(d => d.data[idx] || '').join(',') + '\n';
    });
  }
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `chart-${chartId}-${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
}

// Load real data from DB and render charts
async function loadDashboardData() {
  try {
    const params = new URLSearchParams();
    const start = document.getElementById('dateStart')?.value;
    const end = document.getElementById('dateEnd')?.value;
    
    if (start) params.append('start', start);
    if (end) params.append('end', end);
    
    const res = await fetch(`/api/dashboard/data/?${params.toString()}`);
    const data = await res.json();
    if (data.ok) {
      updateKPI(data);
      renderChartsFromDB(data); // Render charts from real DB data
    } else {
      showEmptyState('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
    }
  } catch (error) {
    console.error('Error loading dashboard data:', error);
    showEmptyState('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
  }
}

function updateKPI(data) {
  if (!data || !data.daily) return;
  
  const daily = data.daily;
  if (daily.income.length === 0) return;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
  const totalIncome = daily.income.reduce((a, b) => a + b, 0);
  const totalExpense = daily.expense.reduce((a, b) => a + b, 0);
  const totalProfit = totalIncome - totalExpense;
  
  document.getElementById('kpi-income').textContent = totalIncome.toFixed(2);
  document.getElementById('kpi-expense').textContent = totalExpense.toFixed(2);
  document.getElementById('kpi-profit').textContent = totalProfit.toFixed(2);
  document.getElementById('kpi-income').closest('.app-card')?.classList.add('pulse');
  document.getElementById('kpi-expense').closest('.app-card')?.classList.add('pulse');
  document.getElementById('kpi-profit').closest('.app-card')?.classList.add('pulse');
  setTimeout(() => {
    document.getElementById('kpi-income').closest('.app-card')?.classList.remove('pulse');
    document.getElementById('kpi-expense').closest('.app-card')?.classList.remove('pulse');
    document.getElementById('kpi-profit').closest('.app-card')?.classList.remove('pulse');
  }, 1300);
  
  // –í—ã—á–∏—Å–ª—è–µ–º –¥–∏–Ω–∞–º–∏–∫—É (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π)
  if (daily.income.length >= 14) {
    const lastWeekIncome = daily.income.slice(-7).reduce((a, b) => a + b, 0);
    const prevWeekIncome = daily.income.slice(-14, -7).reduce((a, b) => a + b, 0);
    const lastWeekExpense = daily.expense.slice(-7).reduce((a, b) => a + b, 0);
    const prevWeekExpense = daily.expense.slice(-14, -7).reduce((a, b) => a + b, 0);
    
    const incomeChange = prevWeekIncome > 0 ? ((lastWeekIncome - prevWeekIncome) / prevWeekIncome * 100) : 0;
    const expenseChange = prevWeekExpense > 0 ? ((lastWeekExpense - prevWeekExpense) / prevWeekExpense * 100) : 0;
    
    const incomeChangeEl = document.getElementById('kpi-income-change');
    const expenseChangeEl = document.getElementById('kpi-expense-change');
    
    if (incomeChangeEl) {
      const sign = incomeChange >= 0 ? '+' : '';
      incomeChangeEl.textContent = `–ó–∞ –Ω–µ–¥–µ–ª—é: ${sign}${incomeChange.toFixed(1)}%`;
      incomeChangeEl.className = incomeChange >= 0 ? 'small text-success mt-2' : 'small text-danger mt-2';
    }
    
    if (expenseChangeEl) {
      const sign = expenseChange >= 0 ? '+' : '';
      expenseChangeEl.textContent = `–ó–∞ –Ω–µ–¥–µ–ª—é: ${sign}${expenseChange.toFixed(1)}%`;
      expenseChangeEl.className = expenseChange >= 0 ? 'small text-danger mt-2' : 'small text-success mt-2';
    }
  }
}

function renderTimeSeriesChart() {
  if (!chartData || !chartData.daily) return;
  
  const daily = chartData.daily;
  const dates = daily.dates.map(d => new Date(d));
  const tv = themeVars();
  const empty = !daily.income || daily.income.length === 0 || (daily.income.reduce((a,b)=>a+b,0) === 0 && daily.expense.reduce((a,b)=>a+b,0) === 0);
  document.getElementById('timeSeriesEmpty').classList.toggle('d-none', !empty);
  document.getElementById('timeSeriesChart').style.display = empty ? 'none' : 'block';
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑—Ä—ã–≤–æ–≤ –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –¥–Ω–∏)
  // –î–ª—è Plotly: –µ—Å–ª–∏ –º–µ–∂–¥—É –¥–∞—Ç–∞–º–∏ –±–æ–ª—å—à–µ 1 –¥–Ω—è - –¥–æ–±–∞–≤–ª—è–µ–º null –¥–ª—è —Ä–∞–∑—Ä—ã–≤–∞ –ª–∏–Ω–∏–∏
  const processDataWithGaps = (values, dates, tooltips = null) => {
    const processedX = [];
    const processedY = [];
    const processedTooltips = [];
    
    for (let i = 0; i < dates.length; i++) {
      processedX.push(dates[i]);
      processedY.push(values[i]);
      if (tooltips && tooltips[i]) {
        processedTooltips.push(tooltips[i]);
      } else {
        processedTooltips.push(null);
      }
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–ø—É—Å–∫ –±–æ–ª—å—à–µ 1.5 –¥–Ω—è, –¥–æ–±–∞–≤–ª—è–µ–º null –¥–ª—è —Ä–∞–∑—Ä—ã–≤–∞ –ª–∏–Ω–∏–∏
      if (i > 0) {
        const daysDiff = (dates[i] - dates[i-1]) / (1000 * 60 * 60 * 24);
        if (daysDiff > 1.5) {
          // –í—Å—Ç–∞–≤–ª—è–µ–º null –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ç–æ—á–∫–∏ –¥–ª—è —Ä–∞–∑—Ä—ã–≤–∞
          const insertIdx = processedX.length - 1;
          processedX.splice(insertIdx, 0, dates[i-1]);
          processedY.splice(insertIdx, 0, null);
          processedTooltips.splice(insertIdx, 0, null);
        }
      }
    }
    return { x: processedX, y: processedY, tooltips: processedTooltips };
  };
  
  const incomeData = processDataWithGaps(daily.income, dates, daily.tooltips_income);
  const expenseData = processDataWithGaps(daily.expense, dates, daily.tooltips_expense);
  
  const traces = [
    {
      x: incomeData.x,
      y: incomeData.y,
      name: '–î–æ—Ö–æ–¥—ã',
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#34A853', width: 4, shape: 'spline', smoothing: 1.3 },
      marker: { size: 8, color: '#34A853', line: { width: 2, color: '#ffffff' } },
      hovertemplate: incomeData.tooltips && incomeData.tooltips.length > 0 ? 
        '%{customdata}<extra></extra>' : 
        '<b>%{fullData.name}</b><br>–î–∞—Ç–∞: %{x|%Y-%m-%d}<br>–°—É–º–º–∞: %{y:,.2f} —Ä—É–±.<extra></extra>',
      customdata: incomeData.tooltips || [],
      connectgaps: false,
    },
    {
      x: expenseData.x,
      y: expenseData.y,
      name: '–†–∞—Å—Ö–æ–¥—ã',
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#FF6363', width: 4, shape: 'spline', smoothing: 1.3 },
      marker: { size: 8, color: '#FF6363', line: { width: 2, color: '#ffffff' } },
      hovertemplate: expenseData.tooltips && expenseData.tooltips.length > 0 ? 
        '%{customdata}<extra></extra>' : 
        '<b>%{fullData.name}</b><br>–î–∞—Ç–∞: %{x|%Y-%m-%d}<br>–°—É–º–º–∞: %{y:,.2f} —Ä—É–±.<extra></extra>',
      customdata: expenseData.tooltips || [],
      connectgaps: false,
    }
  ];
  
  // Profit fill area - –¥–æ–±–∞–≤–ª—è–µ–º –ª–∏–Ω–∏—é –ø—Ä–∏–±—ã–ª–∏ —Å –∑–∞–ª–∏–≤–∫–æ–π
  if (document.getElementById('showProfitFill')?.checked) {
    const profitData = processDataWithGaps(daily.profit, dates);
    
    // –õ–∏–Ω–∏—è –ø—Ä–∏–±—ã–ª–∏ —Å –∑–∞–ª–∏–≤–∫–æ–π –¥–æ –Ω—É–ª—è
    traces.push({
      x: profitData.x,
      y: profitData.y,
      name: '–ü—Ä–∏–±—ã–ª—å',
      type: 'scatter',
      mode: 'lines',
      fill: 'tozeroy',
      fillcolor: 'rgba(37, 99, 235, 0.2)',
      line: { color: '#3B82F6', width: 3, shape: 'spline', smoothing: 1.3 },
      hovertemplate: '<b>üìä –ü—Ä–∏–±—ã–ª—å</b><br>–î–∞—Ç–∞: %{x|%Y-%m-%d}<br>–ü—Ä–∏–±—ã–ª—å: %{y:,.2f} —Ä—É–±.<extra></extra>',
      connectgaps: false,
    });
  }
  
  // Moving average (7 –¥–Ω–µ–π)
  if (showMovingAvg && daily.moving_avg_income) {
    const moving_avg_window = 7;
    const maIncomeValid = [];
    const maExpenseValid = [];
    const maDates = [];
    
    for (let i = moving_avg_window - 1; i < dates.length; i++) {
      if (daily.moving_avg_income[i] !== null) {
        maDates.push(dates[i]);
        maIncomeValid.push(daily.moving_avg_income[i]);
        maExpenseValid.push(daily.moving_avg_expense[i]);
      }
    }
    
    if (maDates.length > 0) {
      traces.push({
        x: maDates,
        y: maIncomeValid,
        name: 'MA –î–æ—Ö–æ–¥—ã (7–¥)',
        type: 'scatter',
        mode: 'lines',
        line: { color: '#34A853', width: 2.5, dash: 'dash', opacity: 0.6 },
        hovertemplate: '<b>MA –î–æ—Ö–æ–¥—ã (7–¥)</b><br>–î–∞—Ç–∞: %{x|%Y-%m-%d}<br>–°—Ä–µ–¥–Ω–µ–µ: %{y:.2f}<extra></extra>',
      });
      
      traces.push({
        x: maDates,
        y: maExpenseValid,
        name: 'MA –†–∞—Å—Ö–æ–¥—ã (7–¥)',
        type: 'scatter',
        mode: 'lines',
        line: { color: '#FF6363', width: 2.5, dash: 'dash', opacity: 0.6 },
        hovertemplate: '<b>MA –†–∞—Å—Ö–æ–¥—ã (7–¥)</b><br>–î–∞—Ç–∞: %{x|%Y-%m-%d}<br>–°—Ä–µ–¥–Ω–µ–µ: %{y:.2f}<extra></extra>',
      });
    }
  }
  
  // Events/Anomalies markers - —Ä–∞–∑–º–µ—â–∞–µ–º –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–∞—Ç–∞—Ö
  if (chartData.events && chartData.events.length > 0) {
    const eventDates = [];
    const eventAmounts = [];
    const eventTexts = [];
    const eventSymbols = [];
    
    chartData.events.forEach(event => {
      const eventDate = new Date(event.date);
      // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –±–ª–∏–∂–∞–π—à–µ–π –¥–∞—Ç—ã –≤ –≥—Ä–∞—Ñ–∏–∫–µ
      let closestIdx = 0;
      let minDiff = Infinity;
      dates.forEach((d, idx) => {
        const diff = Math.abs(d - eventDate);
        if (diff < minDiff) {
          minDiff = diff;
          closestIdx = idx;
        }
      });
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É–º–º—É –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ (–≤—ã—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è)
      const maxY = Math.max(...daily.income, ...daily.expense);
      const markerY = maxY * 1.15; // 15% –≤—ã—à–µ –º–∞–∫—Å–∏–º—É–º–∞
      
      eventDates.push(dates[closestIdx]);
      eventAmounts.push(markerY);
      eventTexts.push(`${event.message}<br>–¢–∏–ø: ${event.type}<br>–í–∞–∂–Ω–æ—Å—Ç—å: ${event.severity || 'medium'}`);
      
      // –†–∞–∑–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
      let symbol = 'circle';
      if (event.type === 'expense_spike') symbol = 'triangle';
      else if (event.type === 'income_drop') symbol = 'diamond';
      else if (event.type === 'negative_balance') symbol = 'x';
      else if (event.type === 'category_growth') symbol = 'star';
      eventSymbols.push(symbol);
    });
    
    if (eventDates.length > 0) {
      traces.push({
        x: eventDates,
        y: eventAmounts,
        name: 'üö© –°–æ–±—ã—Ç–∏—è/–ê–Ω–æ–º–∞–ª–∏–∏',
        type: 'scatter',
        mode: 'markers+text',
        marker: { 
          size: 14, 
          color: '#ffc107',
          symbol: eventSymbols,
          line: { width: 2, color: '#ff9800' },
          opacity: 0.8,
        },
        text: chartData.events.map(e => 'üö©'),
        textposition: 'top center',
        textfont: { size: 12 },
        hovertemplate: '<b>üö© ALERT!</b><br>%{customdata}<extra></extra>',
        customdata: eventTexts,
        hoverlabel: { bgcolor: 'rgba(255, 193, 7, 0.95)', font: { size: 13, color: '#000' } },
      });
    }
  }
  
  const layout = {
    title: { text: '', font: { size: 0 } },
    xaxis: { 
      title: { text: '–î–∞—Ç–∞', font: { size: 13, color: tv.text } },
      type: 'date',
      showgrid: true,
      gridcolor: tv.grid,
      zeroline: false,
      tickformat: '%d.%m.%Y',
      tickfont: { size: 11, color: tv.text },
      linecolor: tv.border || tv.grid,
    },
    yaxis: { 
      title: { text: '–°—É–º–º–∞ (—Ä—É–±.)', font: { size: 13, color: tv.text } },
      showgrid: true,
      gridcolor: tv.grid,
      zeroline: true,
      zerolinecolor: tv.zero,
      zerolinewidth: 2,
      tickformat: ',.0f',
      tickfont: { size: 11, color: tv.text },
      linecolor: tv.border || tv.grid,
    },
    hovermode: 'x unified',
    hoverlabel: { 
      bgcolor: tv.hoverBg || 'rgba(255, 255, 255, 0.95)', 
      font: { size: 13, color: tv.text },
      bordercolor: tv.border || 'rgba(0,0,0,0.1)',
      borderwidth: 1,
    },
    legend: { 
      orientation: 'h', 
      y: -0.15,
      x: 0.5,
      xanchor: 'center',
      font: { size: 13, color: tv.legendText },
      bgcolor: 'transparent',
      bordercolor: 'transparent',
    },
    margin: { l: 80, r: 40, t: 20, b: 80 },
    plot_bgcolor: 'transparent',
    paper_bgcolor: 'transparent',
    font: { family: 'Inter, system-ui, Arial, sans-serif', size: 12, color: tv.text },
  };
  
  const config = {
    responsive: true,
    displayModeBar: true,
    displaylogo: false,
    modeBarButtonsToAdd: ['drawline', 'drawopenpath', 'drawclosedpath', 'drawcircle', 'drawrect', 'eraseshape'],
    modeBarButtonsToRemove: ['lasso2d', 'select2d'],
    toImageButtonOptions: {
      format: 'png',
      filename: 'financial_chart',
      height: 600,
      width: 1200,
      scale: 1
    }
  };
  
  Plotly.newPlot('timeSeriesChart', traces, layout, config);
  charts.timeSeries = true;
}

function renderCumulativeChart() {
  if (!chartData || !chartData.daily) return;
  
  const daily = chartData.daily;
  const dates = daily.dates.map(d => new Date(d));
  const tv = themeVars();
  const empty = !daily.cumulative_income || daily.cumulative_income.length === 0;
  document.getElementById('cumulativeEmpty').classList.toggle('d-none', !empty);
  document.getElementById('cumulativeChart').style.display = empty ? 'none' : 'block';
  
  const traces = [
    {
      x: dates,
      y: daily.cumulative_income,
      name: '–ö—É–º—É–ª—è—Ç–∏–≤–Ω—ã–µ –¥–æ—Ö–æ–¥—ã',
      type: 'scatter',
      mode: 'lines',
      fill: 'tozeroy',
      line: { color: '#34A853', width: 4, shape: 'spline', smoothing: 1.3 },
      fillcolor: 'rgba(52, 168, 83, 0.2)',
      hovertemplate: '<b>–ö—É–º—É–ª—è—Ç–∏–≤–Ω—ã–µ –¥–æ—Ö–æ–¥—ã</b><br>–î–∞—Ç–∞: %{x|%Y-%m-%d}<br>–°—É–º–º–∞: %{y:,.2f} —Ä—É–±.<extra></extra>',
    },
    {
      x: dates,
      y: daily.cumulative_profit,
      name: '–ö—É–º—É–ª—è—Ç–∏–≤–Ω–∞—è –ø—Ä–∏–±—ã–ª—å',
      type: 'scatter',
      mode: 'lines',
      fill: 'tozeroy',
      line: { color: '#3B82F6', width: 4, shape: 'spline', smoothing: 1.3 },
      fillcolor: 'rgba(59, 130, 246, 0.2)',
      hovertemplate: '<b>–ö—É–º—É–ª—è—Ç–∏–≤–Ω–∞—è –ø—Ä–∏–±—ã–ª—å</b><br>–î–∞—Ç–∞: %{x|%Y-%m-%d}<br>–°—É–º–º–∞: %{y:,.2f} —Ä—É–±.<extra></extra>',
    }
  ];
  
  const layout = {
    title: { text: '–ö—É–º—É–ª—è—Ç–∏–≤–Ω—ã–π —Ä–æ—Å—Ç –¥–æ—Ö–æ–¥–æ–≤ –∏ –ø—Ä–∏–±—ã–ª–∏', font: { size: 16, color: tv.text } },
    xaxis: { 
      title: { text: '–î–∞—Ç–∞', font: { size: 12 } },
      type: 'date',
      tickformat: '%d.%m.%Y',
      showgrid: true,
      gridcolor: tv.grid,
    },
    yaxis: { 
      title: { text: '–ö—É–º—É–ª—è—Ç–∏–≤–Ω–∞—è —Å—É–º–º–∞ (—Ä—É–±.)', font: { size: 12 } },
      tickformat: ',.0f',
      showgrid: true,
      gridcolor: tv.grid,
    },
    hovermode: 'x unified',
    hoverlabel: { bgcolor: tv.hoverBg, font: { size: 12, color: tv.text } },
    legend: { 
      orientation: 'h', 
      y: -0.2,
      x: 0.5,
      xanchor: 'center',
    },
    margin: { l: 80, r: 30, t: 50, b: 60 },
    plot_bgcolor: tv.bg,
    paper_bgcolor: tv.paper,
    font: { size: 12 },
  };
  
  const config = { responsive: true, displayModeBar: true };
  
  Plotly.newPlot('cumulativeChart', traces, layout, config);
}

function renderPieCharts() {
  if (!chartData || !chartData.categories) return;
  
  // Expense Pie (Donut)
  const expenseData = chartData.categories.expenses || [];
  document.getElementById('expensePieEmpty').classList.toggle('d-none', expenseData.length > 0);
  if (expenseData.length > 0) {
    const colors = ['#FF6363', '#3B82F6', '#34A853', '#F59E0B', '#8B5CF6', '#10B981', '#EF4444', '#06B6D4', '#6366F1', '#EC4899'];
    const trace = {
      labels: expenseData.map(c => c.category),
      values: expenseData.map(c => c.total),
      type: 'pie',
      hole: 0.5,
      textinfo: 'label+percent',
      textposition: 'outside',
      marker: {
        colors: colors.slice(0, expenseData.length),
        line: { color: '#fff', width: 2 }
      },
      hovertemplate: '<b>%{label}</b><br>–°—É–º–º–∞: %{value:,.2f} —Ä—É–±.<br>–ü—Ä–æ—Ü–µ–Ω—Ç: %{percent}<extra></extra>',
    };
    
    const layout = {
      title: { text: '', font: { size: 14 } },
      margin: { l: 20, r: 20, t: 20, b: 20 },
      showlegend: true,
      legend: { orientation: 'v', x: 1.1, y: 0.5 },
      font: { size: 12 },
    };
    
    const config = { responsive: true, displayModeBar: false };
    
    Plotly.newPlot('expensePieChart', [trace], layout, config).then(() => {
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è drilldown
      document.getElementById('expensePieChart').on('plotly_click', function(data) {
        const clickedCategory = data.points[0].label;
        document.getElementById('categoryFilter').value = clickedCategory;
        loadDashboardData();
      });
    });
  }
  
  // Income Pie (Donut)
  const incomeData = chartData.categories.incomes || [];
  document.getElementById('incomePieEmpty').classList.toggle('d-none', incomeData.length > 0);
  if (incomeData.length > 0) {
    const colors = ['#34A853', '#3B82F6', '#10B981', '#8B5CF6', '#06B6D4', '#6366F1'];
    const trace = {
      labels: incomeData.map(c => c.category),
      values: incomeData.map(c => c.total),
      type: 'pie',
      hole: 0.5,
      textinfo: 'label+percent',
      textposition: 'outside',
      marker: {
        colors: colors.slice(0, incomeData.length),
        line: { color: '#fff', width: 2 }
      },
      hovertemplate: '<b>%{label}</b><br>–°—É–º–º–∞: %{value:,.2f} —Ä—É–±.<br>–ü—Ä–æ—Ü–µ–Ω—Ç: %{percent}<extra></extra>',
    };
    
    const layout = {
      title: { text: '', font: { size: 14 } },
      margin: { l: 20, r: 20, t: 20, b: 20 },
      showlegend: true,
      legend: { orientation: 'v', x: 1.1, y: 0.5 },
      font: { size: 12 },
    };
    
    const config = { responsive: true, displayModeBar: false };
    
    Plotly.newPlot('incomePieChart', [trace], layout, config).then(() => {
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è drilldown
      document.getElementById('incomePieChart').on('plotly_click', function(data) {
        const clickedCategory = data.points[0].label;
        document.getElementById('categoryFilter').value = clickedCategory;
        loadDashboardData();
      });
    });
  }
}

function renderBarChart() {
  if (!chartData || !chartData.categories) return;
  
  const expenseData = chartData.categories.expenses || [];
  document.getElementById('expenseBarEmpty').classList.toggle('d-none', expenseData.length > 0);
  if (expenseData.length === 0) return;
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –¥–ª—è –ª—É—á—à–µ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
  const sortedData = [...expenseData].sort((a, b) => b.total - a.total);
  
  const trace = {
    x: sortedData.map(c => c.category),
    y: sortedData.map(c => c.total),
    type: 'bar',
    marker: {
      color: sortedData.map((_, i) => {
        const colors = ['#FF6363', '#F59E0B', '#3B82F6', '#34A853', '#8B5CF6', '#10B981', '#EC4899'];
        return colors[i % colors.length];
      }),
      line: { color: '#fff', width: 1 },
    },
    hovertemplate: '<b>%{x}</b><br>–°—É–º–º–∞: %{y:,.2f} —Ä—É–±.<extra></extra>',
    text: sortedData.map(c => c.total.toFixed(2)),
    textposition: 'outside',
    textfont: { size: 11 },
  };
  
  const layout = {
    title: { text: '', font: { size: 14 } },
    xaxis: { 
      title: { text: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', font: { size: 12 } },
      tickangle: -45,
    },
    yaxis: { 
      title: { text: '–°—É–º–º–∞ (—Ä—É–±.)', font: { size: 12 } },
      tickformat: ',.0f',
    },
    margin: { l: 70, r: 30, t: 30, b: 100 },
    plot_bgcolor: themeVars().bg,
    paper_bgcolor: themeVars().paper,
    font: { size: 12 },
  };
  
  const config = { responsive: true, displayModeBar: true };
  
  Plotly.newPlot('expenseBarChart', [trace], layout, config).then(() => {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    document.getElementById('expenseBarChart').on('plotly_click', function(data) {
      const clickedCategory = data.points[0].x;
      document.getElementById('categoryFilter').value = clickedCategory;
      loadDashboardData();
    });
  });
}

function renderAllCharts() {
  renderTimeSeriesChart();
  renderCumulativeChart();
  renderPieCharts();
  renderBarChart();
}

function updateCategories(categories) {
  const select = document.getElementById('categoryFilter');
  if (!select) return;
  
  const allCats = new Set();
  (categories.expenses || []).forEach(c => allCats.add(c.category));
  (categories.incomes || []).forEach(c => allCats.add(c.category));
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø—Ü–∏–∏
  const currentValue = select.value;
  select.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
  Array.from(allCats).sort().forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  });
  if (currentValue) select.value = currentValue;
}

function exportChart(chartId) {
  Plotly.downloadImage(chartId, {
    format: 'png',
    width: 1200,
    height: 600,
    filename: 'chart'
  });
}

function exportDataCSV() {
  if (!chartData || !chartData.daily) return;
  
  const daily = chartData.daily;
  let csv = '–î–∞—Ç–∞,–î–æ—Ö–æ–¥—ã,–†–∞—Å—Ö–æ–¥—ã,–ü—Ä–∏–±—ã–ª—å\n';
  for (let i = 0; i < daily.dates.length; i++) {
    csv += `${daily.dates[i]},${daily.income[i]},${daily.expense[i]},${daily.profit[i]}\n`;
  }
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `dashboard_data_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
}

function toggleMovingAvg() {
  showMovingAvg = !showMovingAvg;
  if (chartData) renderTimeSeriesChart();
}

// Old event listeners removed - charts are now auto-generated

// Load insights
async function loadInsights() {
  const params = new URLSearchParams(window.location.search);
  const res = await fetch(`/ai/insights/?${params.toString()}`);
  const data = await res.json();
  
  const alerts = document.getElementById('ai-alerts');
  alerts.innerHTML = '';
  (data.alerts || []).forEach(a => {
    const li = document.createElement('li');
    li.className = 'mb-1';
    li.innerHTML = `<span class="badge bg-warning">${a.severity}</span> ${a.message}`;
    alerts.appendChild(li);
  });
  
  const recs = document.getElementById('ai-recs');
  recs.innerHTML = '';
  (data.recommendations || []).forEach(r => {
    const li = document.createElement('li');
    li.className = 'mb-1';
    li.textContent = r;
    recs.appendChild(li);
  });
}

// Load feed
async function loadFeed() {
  const types = [...document.querySelectorAll('.flt-type:checked')].map(i => `type=${i.value}`).join('&');
  const search = document.getElementById('search').value;
  const params = new URLSearchParams(window.location.search);
  let url = `/records/?${types}`;
  if (search) url += `&search=${encodeURIComponent(search)}`;
  if (params.get('start')) url += `&start=${params.get('start')}`;
  if (params.get('end')) url += `&end=${params.get('end')}`;
  const res = await fetch(url);
  const data = await res.json();
  const feed = document.getElementById('feed');
  feed.innerHTML = '';
  (data.items || []).forEach(it => {
    const li = document.createElement('li');
    const tagStr = (it.tags && it.tags.length) ? ` [${it.tags.join(', ')}]` : '';
    if (it.type === 'income' || it.type === 'expense') {
      li.textContent = `${it.type === 'income' ? 'üí∞ –î–æ—Ö–æ–¥' : 'üí∏ –†–∞—Å—Ö–æ–¥'} ‚Ä¢ ${it.date} ‚Ä¢ ${it.category} ‚Ä¢ ${it.amount}${tagStr}`;
    } else if (it.type === 'event') {
      li.textContent = `üìÖ –°–æ–±—ã—Ç–∏–µ ‚Ä¢ ${it.date} ‚Ä¢ ${it.title}${tagStr}`;
    } else if (it.type === 'document') {
      li.textContent = `üìÑ –î–æ–∫—É–º–µ–Ω—Ç ‚Ä¢ ${it.created_at} ‚Ä¢ ${it.doc_type}${tagStr}`;
    }
    feed.appendChild(li);
  });
}

// Upload handler with progress bar
const uploadForm = document.getElementById('uploadForm');
const csrftoken = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1];
if (uploadForm) {
  uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(uploadForm);
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const submitBtn = document.getElementById('uploadBtn');
    
    try {
      submitBtn?.setAttribute('disabled','disabled');
      progressDiv?.classList.remove('d-none');
      progressBar.style.width = '10%';
      progressText.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ...';
      
      setProcessing(true, '–§–∞–π–ª –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è‚Ä¶', '–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 10 —Å–µ–∫.');
      if (typeof showToast === 'function') showToast('–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å', 'info');
      
      // Simulate progress
      let progress = 10;
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
        if (progress < 40) {
          progressText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...';
        } else if (progress < 70) {
          progressText.textContent = '–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...';
        } else {
          progressText.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è...';
        }
      }, 300);
      
      const res = await fetch('/api/upload/', { method: 'POST', body: formData, headers: { 'X-CSRFToken': csrftoken || '' } });
      clearInterval(progressInterval);
      progressBar.style.width = '100%';
      progressText.textContent = '–ì–æ—Ç–æ–≤–æ!';
      
      const data = await res.json();
      if (!data.ok) { 
        if (typeof showToast === 'function') showToast(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'danger', 5000);
        setProcessing(false);
        submitBtn?.removeAttribute('disabled');
        progressDiv?.classList.add('d-none');
        return; 
      }
      
      setProcessing(false);
      
      setTimeout(() => {
        progressDiv?.classList.add('d-none');
        progressBar.style.width = '0%';
      }, 1000);
      
      // Immediately reload and render charts from real DB data
      if (typeof showToast === 'function') showToast('–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏', 'success');
      await Promise.all([loadDashboardData(), loadInsights(), loadFeed()]);
    } catch (err) {
      console.error(err);
      if (typeof showToast === 'function') showToast('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞', 'danger', 5000);
      setProcessing(false);
      progressDiv?.classList.add('d-none');
    } finally {
      submitBtn?.removeAttribute('disabled');
      uploadForm.reset();
    }
  });
}

// –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∏–Ω–ø—É—Ç—ã —Å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º
let dateInputsInitialised = false;
function syncDateRangeInputs(data) {
  if (dateInputsInitialised) return;
  if (!data || !data.daily || !Array.isArray(data.daily.dates) || data.daily.dates.length === 0) return;
  const startInput = document.getElementById('dateStart');
  const endInput = document.getElementById('dateEnd');
  if (startInput && !startInput.value) startInput.value = data.daily.dates[0];
  if (endInput && !endInput.value) endInput.value = data.daily.dates[data.daily.dates.length - 1];
  dateInputsInitialised = true;
}

// Initialize
document.getElementById('reload')?.addEventListener('click', () => { loadFeed(); loadInsights(); loadDashboardData(); });
document.querySelectorAll('.flt-type').forEach(cb => cb.addEventListener('change', loadFeed));
document.getElementById('filterForm')?.addEventListener('submit', (e) => {
  e.preventDefault();
  loadDashboardData();
  loadInsights();
  loadFeed();
});

// Initialize - load real data from DB
window.addEventListener('load', () => {
  loadFeed();
  loadInsights();
  loadDashboardData(); // This will render charts from real DB data
});

// Re-render charts on theme change
document.addEventListener('theme:changed', () => {
  if (dashboardData && dashboardData.ok) {
    renderChartsFromDB(dashboardData);
  }
});
</script>
{% endblock %}
