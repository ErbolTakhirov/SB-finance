{% extends 'base.html' %}
{% block title %}Расходы{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Расходы</h2>
  <div class="d-flex gap-2">
    <a class="btn btn-primary" href="/expense/create/"><i class="bi bi-plus-circle"></i> Добавить расход</a>
    <a class="btn btn-outline-secondary" href="/expense/export/csv/"><i class="bi bi-download"></i> Экспорт CSV</a>
  </div>
</div>

<!-- Фильтры и управление -->
<div class="app-card p-3 mb-3">
  <div class="row g-3 align-items-end">
    <div class="col-md-4">
      <label class="form-label fw-semibold">Фильтр по файлу</label>
      <select class="form-select" id="fileFilter" onchange="filterByFile()">
        <option value="">Все файлы</option>
        {% for file in source_files %}
        <option value="{{ file.id }}" {% if selected_file_id == file.id|stringformat:"s" %}selected{% endif %}>
          {{ file.original_name }} ({{ file.expense_count }} расходов, {{ file.uploaded_at|date:"d.m.Y" }})
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-8">
      <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-outline-info" onclick="showDuplicates()">
          <i class="bi bi-files"></i> Показать возможные дубли
        </button>
        {% if selected_file_id %}
        <button class="btn btn-outline-danger" onclick="deleteFileTransactions({{ selected_file_id }})">
          <i class="bi bi-trash"></i> Удалить все транзакции этого файла
        </button>
        {% endif %}
        <button class="btn btn-outline-secondary" onclick="clearFilter()">
          <i class="bi bi-x-circle"></i> Сбросить фильтр
        </button>
      </div>
    </div>
  </div>
</div>

<div class="app-card p-3">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead>
        <tr>
          <th>Дата</th>
          <th>Сумма</th>
          <th>Категория</th>
          <th>Описание</th>
          <th>Источник</th>
          <th class="text-end">Действия</th>
        </tr>
      </thead>
      <tbody>
      {% for i in items %}
        <tr>
          <td>{{ i.date }}</td>
          <td><strong>{{ i.amount }}</strong></td>
          <td><span class="badge bg-secondary">{{ i.get_category_display }}</span></td>
          <td>{{ i.description|default:"—" }}</td>
          <td>
            {% if i.source_file %}
            <span class="badge bg-info text-dark" title="Загружено {{ i.source_file.uploaded_at|date:"d.m.Y H:i" }}">
              <i class="bi bi-file-earmark"></i> {{ i.source_file.original_name|truncatechars:30 }}
            </span>
            {% else %}
            <span class="badge bg-light text-muted">Ручной ввод</span>
            {% endif %}
          </td>
          <td class="text-end">
            <div class="btn-group btn-group-sm" role="group">
              <a class="btn btn-outline-primary" href="/expense/{{ i.id }}/edit/"><i class="bi bi-pencil"></i></a>
              <a class="btn btn-outline-danger" href="/expense/{{ i.id }}/delete/"><i class="bi bi-trash"></i></a>
            </div>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="6" class="text-center text-muted">Нет записей</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Модальное окно для дублей -->
<div class="modal fade" id="duplicatesModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Найденные дубликаты</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="duplicatesContent">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Загрузка...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<script>
function filterByFile() {
  const fileId = document.getElementById('fileFilter').value;
  const url = new URL(window.location);
  if (fileId) {
    url.searchParams.set('file_id', fileId);
  } else {
    url.searchParams.delete('file_id');
  }
  window.location.href = url.toString();
}

function clearFilter() {
  window.location.href = '/expense/';
}

function showDuplicates() {
  const fileId = document.getElementById('fileFilter').value;
  const url = '/api/duplicates/find/' + (fileId ? '?file_id=' + fileId : '');
  
  const modal = new bootstrap.Modal(document.getElementById('duplicatesModal'));
  modal.show();
  
  document.getElementById('duplicatesContent').innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
  
  fetch(url)
    .then(response => response.json())
    .then(data => {
      if (!data.ok) {
        document.getElementById('duplicatesContent').innerHTML = '<div class="alert alert-danger">' + data.error + '</div>';
        return;
      }
      
      let html = '';
      
      if (data.duplicates.incomes.length === 0 && data.duplicates.expenses.length === 0) {
        html = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> Дубликаты не найдены!</div>';
      } else {
        if (data.duplicates.incomes.length > 0) {
          html += '<h6 class="mb-3">Доходы:</h6>';
          data.duplicates.incomes.forEach((dup, idx) => {
            html += '<div class="card mb-3">';
            html += '<div class="card-header d-flex justify-content-between align-items-center">';
            html += '<span>Дубликат #' + (idx + 1) + ' (' + dup.count + ' записей)</span>';
            html += '<button class="btn btn-sm btn-danger" onclick="deleteDuplicates(' + JSON.stringify(dup.transactions.map(t => t.id)) + ', \'income\')">Удалить все</button>';
            html += '</div>';
            html += '<div class="card-body">';
            dup.transactions.forEach(t => {
              html += '<div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">';
              html += '<div>';
              html += '<strong>' + t.amount + '</strong> - ' + t.category + ' (' + t.date + ')';
              if (t.description) html += '<br><small class="text-muted">' + t.description + '</small>';
              if (t.source_file) html += '<br><small class="badge bg-info">' + t.source_file + '</small>';
              html += '</div>';
              html += '<div class="form-check">';
              html += '<input class="form-check-input" type="checkbox" value="' + t.id + '" data-type="income">';
              html += '</div>';
              html += '</div>';
            });
            html += '</div></div>';
          });
        }
        
        if (data.duplicates.expenses.length > 0) {
          html += '<h6 class="mb-3 mt-4">Расходы:</h6>';
          data.duplicates.expenses.forEach((dup, idx) => {
            html += '<div class="card mb-3">';
            html += '<div class="card-header d-flex justify-content-between align-items-center">';
            html += '<span>Дубликат #' + (idx + 1) + ' (' + dup.count + ' записей)</span>';
            html += '<button class="btn btn-sm btn-danger" onclick="deleteDuplicates(' + JSON.stringify(dup.transactions.map(t => t.id)) + ', \'expense\')">Удалить все</button>';
            html += '</div>';
            html += '<div class="card-body">';
            dup.transactions.forEach(t => {
              html += '<div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">';
              html += '<div>';
              html += '<strong>' + t.amount + '</strong> - ' + t.category + ' (' + t.date + ')';
              if (t.description) html += '<br><small class="text-muted">' + t.description + '</small>';
              if (t.source_file) html += '<br><small class="badge bg-info">' + t.source_file + '</small>';
              html += '</div>';
              html += '<div class="form-check">';
              html += '<input class="form-check-input" type="checkbox" value="' + t.id + '" data-type="expense">';
              html += '</div>';
              html += '</div>';
            });
            html += '</div></div>';
          });
        }
        
        html += '<div class="mt-3">';
        html += '<button class="btn btn-primary" onclick="deleteSelectedDuplicates()">Удалить выбранные</button>';
        html += '</div>';
      }
      
      document.getElementById('duplicatesContent').innerHTML = html;
    })
    .catch(error => {
      document.getElementById('duplicatesContent').innerHTML = '<div class="alert alert-danger">Ошибка: ' + error + '</div>';
    });
}

function deleteDuplicates(ids, type) {
  if (!confirm('Вы действительно хотите удалить эти ' + ids.length + ' транзакций?')) {
    return;
  }
  
  fetch('/api/duplicates/delete/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({transaction_ids: ids, type: type})
  })
  .then(response => response.json())
  .then(data => {
    if (data.ok) {
      alert(data.message);
      location.reload();
    } else {
      alert('Ошибка: ' + data.error);
    }
  });
}

function deleteSelectedDuplicates() {
  const checkboxes = document.querySelectorAll('#duplicatesContent input[type="checkbox"]:checked');
  const incomeIds = [];
  const expenseIds = [];
  
  checkboxes.forEach(cb => {
    if (cb.dataset.type === 'income') {
      incomeIds.push(parseInt(cb.value));
    } else {
      expenseIds.push(parseInt(cb.value));
    }
  });
  
  if (incomeIds.length === 0 && expenseIds.length === 0) {
    alert('Выберите транзакции для удаления');
    return;
  }
  
  if (!confirm('Вы действительно хотите удалить выбранные транзакции?')) {
    return;
  }
  
  const csrftoken = getCookie('csrftoken');
  Promise.all([
    incomeIds.length > 0 ? fetch('/api/duplicates/delete/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify({transaction_ids: incomeIds, type: 'income'})
    }).then(r => r.json()) : Promise.resolve({ok: true}),
    expenseIds.length > 0 ? fetch('/api/duplicates/delete/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify({transaction_ids: expenseIds, type: 'expense'})
    }).then(r => r.json()) : Promise.resolve({ok: true})
  ]).then(results => {
    if (results.every(r => r.ok)) {
      alert('Транзакции удалены');
      location.reload();
    } else {
      alert('Ошибка при удалении');
    }
  });
}

function deleteFileTransactions(fileId) {
  const fileName = document.querySelector('#fileFilter option[value="' + fileId + '"]').textContent;
  if (!confirm('Вы действительно хотите удалить все транзакции, связанные с файлом "' + fileName + '"?\n\nЭто действие нельзя отменить!')) {
    return;
  }
  
  fetch('/api/files/' + fileId + '/delete-transactions/', {
    method: 'POST',
    headers: {'X-CSRFToken': getCookie('csrftoken')}
  })
  .then(response => response.json())
  .then(data => {
    if (data.ok) {
      alert(data.message);
      location.reload();
    } else {
      alert('Ошибка: ' + data.error);
    }
  });
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}
