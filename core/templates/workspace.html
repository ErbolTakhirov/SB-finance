{% extends 'base.html' %}
{% block title %}AI Workspace - –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ç—Ä–µ–∫–∏–Ω–≥{% endblock %}

{% block extra_head %}
<!-- Markdown parser -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
<!-- Chart.js for interactive charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- Highlight.js for code blocks -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<!-- Client-side encryption utilities -->
<script src="/static/js/crypto.js"></script>

<style>
/* ============================================================================
   AI WORKSPACE STYLES - –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω –≤ —Å—Ç–∏–ª–µ Notion AI / ChatGPT
   ============================================================================ */
:root {
  --bg-primary: #ffffff;
  --bg-secondary: #f8fafc;
  --bg-tertiary: #f1f5f9;
  --text-primary: #0f172a;
  --text-secondary: #475569;
  --text-tertiary: #94a3b8;
  --border-color: #e2e8f0;
  --accent: #3b82f6;
  --accent-hover: #2563eb;
  --success: #10b981;
  --error: #ef4444;
  --warning: #f59e0b;
  --message-user-bg: #3b82f6;
  --message-user-text: #ffffff;
  --message-assistant-bg: #f1f5f9;
  --message-assistant-text: #0f172a;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  --radius: 12px;
  --radius-sm: 8px;
}

[data-theme="dark"] {
  --bg-primary: #000000;
  --bg-secondary: #0D0D0D;
  --bg-tertiary: #1A1A1A;
  --text-primary: #ECECEC;
  --text-secondary: #D1D1D1;
  --text-tertiary: #A8A8A8;
  --border-color: rgba(255, 255, 255, 0.1);
  --accent: #10A37F;
  --accent-hover: #0D8F6E;
  --message-user-bg: #10A37F;
  --message-assistant-bg: transparent;
  --message-assistant-text: #ECECEC;
}

body {
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
  line-height: 1.6;
}

[data-theme="dark"] body {
  background: #000000;
}

.workspace-container {
  display: grid;
  grid-template-columns: 320px 1fr; /* Sidebar | Chat */
  gap: 24px;
  height: calc(100vh - 80px);
  padding: 24px;
  max-width: 1600px;
  margin: 0 auto;
}

.main-column {
  display: flex;
  flex-direction: column;
  gap: 24px;
  min-height: calc(100vh - 80px);
}

.analytics-panel {
  display: flex;
  flex-direction: column;
  background: var(--bg-primary);
  border-radius: var(--radius);
  border: 1px solid var(--border-color);
  box-shadow: var(--shadow-lg);
  overflow: hidden;
  transition: border 0.2s ease, box-shadow 0.2s ease;
}

.analytics-panel.empty .analytics-warnings,
.analytics-panel.empty .analytics-content {
  display: none;
}

.analytics-panel.empty .analytics-empty-state {
  padding: 20px;
  font-size: 13px;
  color: var(--text-secondary);
}

.analytics-panel:not(.empty) .analytics-empty-state {
  display: none;
}

.analytics-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 16px;
}

.analytics-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
}

.analytics-subtitle {
  margin: 4px 0 0;
  font-size: 13px;
  color: var(--text-secondary);
}

.analytics-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.analytics-warnings {
  padding: 12px 20px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.analytics-warnings.hidden {
  display: none;
}

.analytics-warning-pill {
  padding: 6px 12px;
  border-radius: 999px;
  background: rgba(245, 158, 11, 0.15);
  border: 1px solid rgba(245, 158, 11, 0.4);
  color: var(--warning);
  font-size: 12px;
}

.analytics-content {
  display: grid;
  grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
  gap: 20px;
  padding: 20px;
}

.analytics-left {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.analytics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 16px;
}

.analytics-grid.secondary {
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}

.analytics-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  min-height: 220px;
  cursor: pointer;
  transition: border 0.2s ease, box-shadow 0.2s ease;
}

.analytics-card:hover {
  border-color: var(--accent);
  box-shadow: var(--shadow-md);
}

.analytics-card.active {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
}

.analytics-card h4 {
  margin: 0;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}

.analytics-card canvas {
  flex: 1;
  min-height: 180px;
}

.analytics-card .chart-meta {
  font-size: 12px;
  color: var(--text-tertiary);
}

.analytics-detail {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  padding: 16px;
  min-height: 260px;
  overflow: auto;
}

.analytics-detail h4 {
  margin-top: 0;
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
}

.analytics-detail .detail-meta {
  list-style: none;
  padding: 0;
  margin: 12px 0;
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  font-size: 12px;
  color: var(--text-secondary);
}

.analytics-detail .detail-meta span {
  font-weight: 600;
  color: var(--text-primary);
  margin-right: 4px;
}

.analytics-alerts {
  margin-top: 12px;
  padding: 12px;
  border-radius: var(--radius-sm);
  border: 1px solid rgba(245, 158, 11, 0.4);
  background: rgba(245, 158, 11, 0.08);
  font-size: 12px;
  color: var(--warning);
}

.analytics-alerts ul {
  margin: 8px 0 0;
  padding-left: 18px;
}

.analytics-alerts li {
  margin-bottom: 4px;
}

.analytics-detail p {
  font-size: 13px;
  color: var(--text-secondary);
}

.analytics-detail table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  font-size: 12px;
}

.analytics-detail th,
.analytics-detail td {
  padding: 6px 8px;
  border-bottom: 1px solid var(--border-color);
  text-align: left;
}

.analytics-detail tr:last-child td {
  border-bottom: none;
}

.analytics-placeholder {
  text-align: center;
  color: var(--text-secondary);
  padding: 20px;
}

.analytics-placeholder h4 {
  margin-bottom: 6px;
  font-size: 14px;
  font-weight: 600;
}

@media (max-width: 1200px) {
  .workspace-container { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
  .analytics-content { grid-template-columns: 1fr; }
}
/* Sidebar (Chat History) */
.sidebar-panel {
  display: flex;
  flex-direction: column;
  background: var(--bg-primary);
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border-color);
  overflow: hidden;
  min-width: 280px;
}

.sidebar-header {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  gap: 8px;
  align-items: center;
}

.sidebar-search {
  flex: 1;
  padding: 8px 10px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  background: var(--bg-secondary);
  color: var(--text-primary);
  font-size: 14px;
}

.sidebar-actions { display: flex; gap: 6px; }
.btn-icon { padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); cursor: pointer; }
.btn-icon:hover { background: var(--bg-tertiary); }

.chat-list { flex: 1; overflow-y: auto; padding: 8px; }
.chat-item { padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); margin-bottom: 8px; cursor: pointer; }
.chat-item.active { border-color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); }
.chat-item-title { font-weight: 600; font-size: 14px; color: var(--text-primary); }
.chat-item-meta { font-size: 12px; color: var(--text-tertiary); margin-top: 4px; display: flex; justify-content: space-between; }
.chat-item-preview { font-size: 12px; color: var(--text-secondary); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.sidebar-footer { padding: 10px 12px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; }


/* Chat Interface */
.chat-panel {
  display: flex;
  flex-direction: column;
  background: var(--bg-primary);
  border-radius: 0;
  box-shadow: none;
  border: none;
  overflow: hidden;
  flex: 1;
}

[data-theme="dark"] .chat-panel {
  background: #000000;
}

.chat-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: center;
  align-items: center;
  background: var(--bg-primary);
  max-width: 768px;
  margin: 0 auto;
  width: 100%;
}

.chat-header h2 {
  margin: 0;
  font-size: 16px;
  font-weight: 500;
  color: var(--text-primary);
  letter-spacing: -0.01em;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 0;
  max-width: 768px;
  margin: 0 auto;
  width: 100%;
}

.message {
  display: flex;
  gap: 0;
  padding: 20px 0;
  animation: fadeIn 0.3s ease-in;
  position: relative;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.message.user {
  flex-direction: row-reverse;
  background: transparent;
}

.message.assistant {
  background: transparent;
}

.message-avatar {
  width: 30px;
  height: 30px;
  border-radius: 2px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 12px;
  flex-shrink: 0;
  margin: 0 16px;
}

.message.user .message-avatar {
  background: var(--message-user-bg);
  color: white;
  display: none;
}

.message.assistant .message-avatar {
  background: transparent;
  color: var(--text-primary);
  border: none;
  font-size: 20px;
}

.message-content {
  max-width: 768px;
  padding: 0;
  border-radius: 0;
  word-wrap: break-word;
  line-height: 1.75;
  font-size: 16px;
  color: var(--text-primary);
}

.message-content p {
  margin: 0 0 16px 0;
}

.message-content p:last-child {
  margin-bottom: 0;
}

.message-content ul,
.message-content ol {
  margin: 16px 0;
  padding-left: 24px;
}

.message-content li {
  margin: 8px 0;
}

.message.user .message-content {
  background: transparent;
  color: var(--text-primary);
  border-radius: 0;
  box-shadow: none;
  padding: 0;
  margin-left: auto;
  text-align: right;
}

.message.assistant .message-content {
  background: transparent;
  color: var(--text-primary);
  border: none;
  border-radius: 0;
  padding: 0;
}

/* Markdown styling */
.message-content :global(h1),
.message-content :global(h2),
.message-content :global(h3),
.message-content :global(h4) {
  margin-top: 16px;
  margin-bottom: 8px;
  font-weight: 600;
  line-height: 1.4;
}

.message-content :global(h1) { font-size: 24px; }
.message-content :global(h2) { font-size: 20px; }
.message-content :global(h3) { font-size: 18px; }
.message-content :global(h4) { font-size: 16px; }

.message-content :global(p) {
  margin: 8px 0;
}

.message-content :global(ul),
.message-content :global(ol) {
  margin: 8px 0;
  padding-left: 24px;
}

.message-content :global(li) {
  margin: 4px 0;
}

.message-content :global(table) {
  width: 100%;
  border-collapse: collapse;
  margin: 16px 0;
  font-size: 14px;
}

.message-content :global(th),
.message-content :global(td) {
  padding: 8px 12px;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

.message-content :global(th) {
  background: var(--bg-tertiary);
  font-weight: 600;
}

.message-content :global(code) {
  background: var(--bg-tertiary);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.9em;
  font-family: 'Monaco', 'Courier New', monospace;
}

.message-content :global(pre) {
  background: var(--bg-tertiary);
  padding: 12px;
  border-radius: var(--radius-sm);
  overflow-x: auto;
  margin: 12px 0;
}

.message-content :global(blockquote) {
  border-left: 3px solid var(--accent);
  padding-left: 16px;
  margin: 12px 0;
  color: var(--text-secondary);
  font-style: italic;
}

.message-content :global(strong) {
  font-weight: 600;
}

.message-content :global(em) {
  font-style: italic;
}

.chat-input-container {
  padding: 24px;
  border-top: 1px solid var(--border-color);
  background: var(--bg-primary);
  max-width: 768px;
  margin: 0 auto;
  width: 100%;
}

.chat-input-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-bottom: 12px;
}

.chat-input-wrapper {
  display: flex;
  gap: 0;
  align-items: flex-end;
  position: relative;
  border: 1px solid var(--border-color);
  border-radius: 24px;
  background: var(--bg-primary);
  padding: 12px 16px;
  transition: all 0.2s ease;
}

.chat-input-wrapper:focus-within {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent);
}

[data-theme="dark"] .chat-input-wrapper {
  background: var(--bg-secondary);
  border-color: rgba(255, 255, 255, 0.2);
}

[data-theme="dark"] .chat-input-wrapper:focus-within {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent);
}

.chat-input {
  flex: 1;
  padding: 0;
  border: none;
  border-radius: 0;
  background: transparent;
  color: var(--text-primary);
  font-size: 16px;
  resize: none;
  min-height: 24px;
  max-height: 200px;
  font-family: inherit;
  transition: none;
  outline: none;
}

.chat-input:focus {
  outline: none;
  border: none;
  box-shadow: none;
  background: transparent;
}

.send-button {
  padding: 8px;
  background: transparent;
  color: var(--accent);
  border: none;
  border-radius: 50%;
  font-weight: 400;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  min-height: 32px;
  flex-shrink: 0;
}

.send-button:hover:not(:disabled) {
  background: rgba(16, 163, 127, 0.1);
  color: var(--accent);
  transform: none;
  box-shadow: none;
}

.send-button:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

/* Workspace Panel */
.workspace-panel {
  display: flex;
  flex-direction: column;
  background: var(--bg-primary);
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border-color);
  overflow: hidden;
}

.workspace-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.workspace-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.workspace-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.file-upload-area {
  border: 2px dashed var(--border-color);
  border-radius: var(--radius-sm);
  padding: 32px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--bg-secondary);
}

.file-upload-area:hover {
  border-color: var(--accent);
  background: var(--bg-tertiary);
}

.file-upload-area.dragover {
  border-color: var(--accent);
  background: rgba(59, 130, 246, 0.1);
}

.upload-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}

.stat-card {
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-color);
}

.stat-label {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 4px;
}

.stat-value {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
}

.chart-container {
  margin: 20px 0;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-color);
}

.loading {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid var(--border-color);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error-message {
  padding: 12px 16px;
  background: rgba(239, 68, 68, 0.1);
  color: var(--error);
  border-radius: var(--radius-sm);
  margin: 8px 0;
  border: 1px solid rgba(239, 68, 68, 0.2);
}

.success-message {
  padding: 12px 16px;
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
  border-radius: var(--radius-sm);
  margin: 8px 0;
  border: 1px solid rgba(16, 185, 129, 0.2);
}
</style>
{% endblock %}

{% block content %}
<div class="workspace-container">
  <!-- Sidebar: Chat History -->
  <div class="sidebar-panel">
    <div class="sidebar-header">
      <input id="chatSearch" class="sidebar-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏" />
      <div class="sidebar-actions">
        <button id="btnNewChat" class="btn-icon" title="–ù–æ–≤—ã–π —á–∞—Ç">Ôºã</button>
        <button id="btnCompare" class="btn-icon" title="–°—Ä–∞–≤–Ω–∏—Ç—å —á–∞—Ç—ã">‚áÑ</button>
      </div>
    </div>
    <div id="chatList" class="chat-list"></div>
    <div class="sidebar-footer">
      <button id="btnRenameChat" class="btn btn-outline-secondary btn-sm" style="flex:1;">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
      <button id="btnDeleteChat" class="btn btn-outline-danger btn-sm">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
  <div class="main-column">
    <div class="analytics-panel empty" id="autoAnalyticsPanel">
      <div class="analytics-header">
        <div>
          <h3>üìä –ê–≤—Ç–æ–∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
          <p class="analytics-subtitle" id="autoAnalyticsSummary">–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV –∏–ª–∏ Excel, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≥–æ—Ç–æ–≤—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏.</p>
        </div>
        <div class="analytics-actions">
          <button id="btnCustomChart" class="btn btn-outline-primary btn-sm" disabled>–î–æ–±–∞–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>
        </div>
      </div>
      <div id="autoAnalyticsWarnings" class="analytics-warnings hidden"></div>
      <div class="analytics-content">
        <div class="analytics-left">
          <div id="autoChartsPrimary" class="analytics-grid"></div>
          <div id="autoChartsSecondary" class="analytics-grid secondary"></div>
        </div>
        <div class="analytics-detail" id="autoChartDetail">
          <div class="analytics-placeholder">
            <h4>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h4>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ñ–∞–π–ª, –∏ —è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–µ—Ä—É –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.</p>
          </div>
        </div>
      </div>
      <div class="analytics-empty-state">
        <strong>–ì–æ—Ç–æ–≤—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞.</strong><br>
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∫–æ–ª–æ–Ω–∫–∏: –¥–∞—Ç–∞, —Å—É–º–º–∞, –∫–∞—Ç–µ–≥–æ—Ä–∏—è, —Å—á—ë—Ç, –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç.
      </div>
    </div>
    <!-- Chat Panel -->
    <div class="chat-panel">
    <div class="chat-header">
      <h2>üí¨ AI –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ê–Ω–∞–ª–∏—Ç–∏–∫</h2>
    </div>
    
    <div class="chat-messages" id="chatMessages">
      <div class="message assistant">
        <div class="message-avatar">ü§ñ</div>
        <div class="message-content">
          <p>–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à AI —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫. –Ø –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º:</p>
          <ul>
            <li>–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</li>
            <li>–ù–∞—Ö–æ–¥–∏—Ç—å —Ç—Ä–µ–Ω–¥—ã –∏ –∞–Ω–æ–º–∞–ª–∏–∏</li>
            <li>–î–∞–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</li>
            <li>–û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –≤–∞—à–∏—Ö —Ñ–∏–Ω–∞–Ω—Å–∞—Ö</li>
          </ul>
          <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ (CSV, Excel) –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã!</p>
        </div>
      </div>
    </div>
    
    <div class="chat-input-container">
      <div class="chat-input-actions">
        <button id="fileUploadBtn" class="btn btn-sm btn-link" style="padding: 4px 8px; color: var(--text-secondary); border: none; text-decoration: none;" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª">
          <i class="bi bi-paperclip" style="font-size: 18px;"></i>
        </button>
        <button id="clearChat" class="btn btn-sm btn-link" style="padding: 4px 8px; color: var(--text-secondary); border: none; text-decoration: none;" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">
          <i class="bi bi-x-circle" style="font-size: 18px;"></i>
        </button>
      </div>
      <div class="chat-input-wrapper">
        <textarea 
          id="chatInput" 
          class="chat-input" 
          placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ ChatGPT..."
          rows="1"
        ></textarea>
        <button id="sendButton" class="send-button" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
          <i class="bi bi-send-fill"></i>
        </button>
      </div>
      <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.pdf,.docx" style="display: none;" />
    </div>
    </div>
  </div>

</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.pdf,.docx" />
        <div style="font-size:12px;color:var(--text-tertiary);margin-top:8px;">CSV, Excel, PDF, DOCX</div>
      </div>
      <div class="modal-footer">
        <button type="button" id="uploadConfirm" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="customChartModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">–¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞</label>
          <select id="customChartType" class="form-select">
            <option value="bar">–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞</option>
            <option value="horizontalBar">–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞</option>
            <option value="pie">–ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞</option>
            <option value="line">–õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">–ò–∑–º–µ—Ä–µ–Ω–∏–µ</label>
          <select id="customChartDimension" class="form-select"></select>
        </div>
        <div class="mb-3">
          <label class="form-label">–ú–µ—Ç—Ä–∏–∫–∞</label>
          <select id="customChartMetric" class="form-select"></select>
        </div>
        <div class="mb-3">
          <label class="form-label">–ê–≥—Ä–µ–≥–∞—Ü–∏—è</label>
          <select id="customChartAggregation" class="form-select">
            <option value="sum">–°—É–º–º–∞</option>
            <option value="avg">–°—Ä–µ–¥–Ω–µ–µ</option>
            <option value="count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</option>
          </select>
        </div>
        <div id="customChartError" class="text-danger small"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" id="customChartSave" class="btn btn-primary">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================================
// AI WORKSPACE JAVASCRIPT
// ============================================================================

let sessionId = localStorage.getItem('chatSessionId') || null;
let autoChartState = {
  lastPayload: null,
  instances: {},
  activeChartId: null,
  fileId: null,
  anomalies: [],
  modal: null,
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  initChat();
  initUploadModal();
  initAutoAnalytics();
  loadUserSettings();
  loadChatSessions();
  wireSidebarControls();
});
// Sidebar: chat history
let allSessions = [];

function wireSidebarControls() {
  const search = document.getElementById('chatSearch');
  search.addEventListener('input', () => renderChatList(search.value.trim().toLowerCase()));
  document.getElementById('btnNewChat').addEventListener('click', newChat);
  document.getElementById('btnCompare').addEventListener('click', openCompareDialog);
  document.getElementById('btnRenameChat').addEventListener('click', renameChat);
  document.getElementById('btnDeleteChat').addEventListener('click', deleteChat);
}

async function loadChatSessions() {
  try {
    const resp = await fetch('/api/chat/sessions/?page_size=100');
    const data = await resp.json();
    allSessions = data.sessions || [];
    renderChatList(document.getElementById('chatSearch').value.trim().toLowerCase());
  } catch (e) {
    console.error('Failed to load chat sessions', e);
  }
}

function renderChatList(filter = '') {
  const list = document.getElementById('chatList');
  list.innerHTML = '';
  let sessions = allSessions;
  if (filter) {
    sessions = sessions.filter(s => (s.title || '').toLowerCase().includes(filter) || (s.session_id || '').includes(filter));
  }
  sessions.forEach(s => {
    const item = document.createElement('div');
    item.className = 'chat-item' + (s.session_id === sessionId ? ' active' : '');
    item.addEventListener('click', () => openChat(s.session_id));
    const title = document.createElement('div');
    title.className = 'chat-item-title';
    title.textContent = s.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    const meta = document.createElement('div');
    meta.className = 'chat-item-meta';
    const d = new Date(s.updated_at);
    meta.innerHTML = `<span>${d.toLocaleDateString()}</span><span>${s.message_count} —Å–æ–æ–±—â–µ–Ω–∏–π</span>`;
    const preview = document.createElement('div');
    preview.className = 'chat-item-preview';
    preview.textContent = s.data_summaries ? Object.values(s.data_summaries).map(v => v.original_name).filter(Boolean).slice(0,2).join(', ') : '';
    item.appendChild(title); item.appendChild(meta); item.appendChild(preview);
    list.appendChild(item);
  });
}

// ==========================
// Auto analytics dashboard
// ==========================
function initAutoAnalytics() {
  const panel = document.getElementById('autoAnalyticsPanel');
  if (!panel) {
    return;
  }
  clearAutoCharts();
  const customBtn = document.getElementById('btnCustomChart');
  if (customBtn) {
    customBtn.addEventListener('click', openCustomChartModal);
  }
  const saveBtn = document.getElementById('customChartSave');
  if (saveBtn) {
    saveBtn.addEventListener('click', submitCustomChart);
  }
  const modalEl = document.getElementById('customChartModal');
  if (modalEl) {
    modalEl.addEventListener('hidden.bs.modal', () => {
      autoChartState.modal = null;
      const errorEl = document.getElementById('customChartError');
      if (errorEl) {
        errorEl.textContent = '';
      }
    });
  }
}

function destroyAutoCharts() {
  Object.values(autoChartState.instances || {}).forEach(instance => {
    if (instance && typeof instance.destroy === 'function') {
      instance.destroy();
    }
  });
  autoChartState.instances = {};
}

function clearAutoCharts() {
  destroyAutoCharts();
  autoChartState.lastPayload = null;
  autoChartState.activeChartId = null;
  autoChartState.fileId = null;
  autoChartState.anomalies = [];
  renderAutoCharts(null, null);
}

function renderAutoCharts(payload, fileId) {
  const panel = document.getElementById('autoAnalyticsPanel');
  const summaryEl = document.getElementById('autoAnalyticsSummary');
  const warningsEl = document.getElementById('autoAnalyticsWarnings');
  const primaryContainer = document.getElementById('autoChartsPrimary');
  const secondaryContainer = document.getElementById('autoChartsSecondary');
  const detailEl = document.getElementById('autoChartDetail');
  const customBtn = document.getElementById('btnCustomChart');

  destroyAutoCharts();
  autoChartState.lastPayload = payload;
  autoChartState.fileId = fileId || null;
  autoChartState.activeChartId = null;
  if (payload && Array.isArray(payload.anomaly_alerts)) {
    autoChartState.anomalies = payload.anomaly_alerts;
  }

  if (!panel || !summaryEl || !warningsEl || !primaryContainer || !secondaryContainer || !detailEl) {
    return;
  }

  if (customBtn) {
    customBtn.disabled = !fileId;
  }

  primaryContainer.innerHTML = '';
  secondaryContainer.innerHTML = '';
  warningsEl.innerHTML = '';
  detailEl.innerHTML = '<div class="analytics-placeholder"><h4>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h4><p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ñ–∞–π–ª, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏.</p></div>';

  if (!payload || !payload.ok) {
    panel.classList.add('empty');
    const message = payload && payload.error ? payload.error : '–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV –∏–ª–∏ Excel –¥–ª—è –∞–≤—Ç–æ–∞–Ω–∞–ª–∏—Ç–∏–∫–∏.';
    summaryEl.textContent = message;
    warningsEl.classList.add('hidden');
    detailEl.innerHTML = `<div class="analytics-placeholder"><h4>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h4><p>${escapeHtml(message)}</p></div>`;
    return;
  }

  panel.classList.remove('empty');

  const headline = payload.insights && payload.insights.headline ? payload.insights.headline : '–ì–æ—Ç–æ–≤—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.';
  const rowCount = typeof payload.row_count === 'number' ? formatNumber(payload.row_count) : null;
  summaryEl.textContent = rowCount ? `${headline} ¬∑ ${rowCount} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π` : headline;

  const warnings = Array.isArray(payload.warnings) ? payload.warnings : [];
  if (warnings.length) {
    warningsEl.classList.remove('hidden');
    warnings.slice(0, 4).forEach(item => {
      const pill = document.createElement('div');
      pill.className = 'analytics-warning-pill';
      pill.textContent = item;
      warningsEl.appendChild(pill);
    });
  } else {
    warningsEl.classList.add('hidden');
  }

  const chartsList = Array.isArray(payload.charts) ? payload.charts : [];
  if (!chartsList.length) {
    detailEl.innerHTML = '<div class="analytics-placeholder"><h4>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö</h4><p>–î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, —á—Ç–æ–±—ã –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏.</p></div>';
    return;
  }

  const primaryIds = new Set(payload.primary_chart_ids || []);
  const primaryCharts = [];
  const secondaryCharts = [];

  chartsList.forEach(chart => {
    if (primaryIds.has(chart.id) && primaryCharts.length < 3) {
      primaryCharts.push(chart);
    } else {
      secondaryCharts.push(chart);
    }
  });

  if (!primaryCharts.length && chartsList.length) {
    primaryCharts.push(chartsList[0]);
    secondaryCharts.shift();
  }

  primaryCharts.forEach(chart => renderAnalyticsCard(chart, primaryContainer));
  secondaryCharts.forEach(chart => renderAnalyticsCard(chart, secondaryContainer));

  const initialChart = primaryCharts[0] || chartsList[0];
  if (initialChart) {
    activateChart(initialChart.id);
  }
}

function renderAnalyticsCard(chart, container) {
  if (!chart || !container) {
    return;
  }
  const card = document.createElement('div');
  card.className = 'analytics-card';
  card.dataset.chartId = chart.id;

  const title = document.createElement('h4');
  title.textContent = chart.title || '–ì—Ä–∞—Ñ–∏–∫';
  card.appendChild(title);

  const canvas = document.createElement('canvas');
  card.appendChild(canvas);

  const metaInfo = describeChartMeta(chart);
  if (metaInfo) {
    const metaEl = document.createElement('div');
    metaEl.className = 'chart-meta';
    metaEl.textContent = metaInfo;
    card.appendChild(metaEl);
  }

  card.addEventListener('click', () => activateChart(chart.id));
  container.appendChild(card);

  try {
    const ctx = canvas.getContext('2d');
    const config = {
      type: chart.type || 'bar',
      data: chart.chartjs && chart.chartjs.data ? chart.chartjs.data : {},
      options: chart.chartjs && chart.chartjs.options ? chart.chartjs.options : {},
    };
    autoChartState.instances[chart.id] = new Chart(ctx, config);
  } catch (error) {
    console.error('Chart rendering error', error);
    const fallback = document.createElement('div');
    fallback.className = 'analytics-placeholder';
    fallback.innerHTML = '<p>–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫.</p>';
    canvas.replaceWith(fallback);
  }
}

function describeChartMeta(chart) {
  const meta = chart && chart.meta ? chart.meta : {};
  const parts = [];
  if (meta.frequency) {
    parts.push(formatMetaValue('frequency', meta.frequency));
  }
  if (meta.records) {
    parts.push(`${formatNumber(meta.records)} –∑–∞–ø–∏—Å–µ–π`);
  }
  if (meta.aggregation) {
    parts.push(`–ê–≥—Ä–µ–≥–∞—Ü–∏—è: ${formatMetaValue('aggregation', meta.aggregation)}`);
  }
  if (meta.source) {
    parts.push(`–ò—Å—Ç–æ—á–Ω–∏–∫: ${formatMetaValue('source', meta.source)}`);
  }
  if (meta.anomalies) {
    parts.push(`${formatNumber(meta.anomalies)} –∞–Ω–æ–º–∞–ª–∏–π`);
  }
  return parts.join(' ¬∑ ');
}

function activateChart(chartId) {
  if (!autoChartState.lastPayload || !chartId) {
    return;
  }
  autoChartState.activeChartId = chartId;
  document.querySelectorAll('.analytics-card').forEach(card => {
    card.classList.toggle('active', card.dataset.chartId === chartId);
  });
  const chartsList = autoChartState.lastPayload.charts || [];
  const chart = chartsList.find(item => item.id === chartId);
  renderChartDetail(chart);
}

function renderChartDetail(chart) {
  const detailEl = document.getElementById('autoChartDetail');
  if (!detailEl) {
    return;
  }
  if (!chart) {
    detailEl.innerHTML = '<div class="analytics-placeholder"><h4>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h4><p>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä–∞—Ñ–∏–∫ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏.</p></div>';
    return;
  }

  const insight = chart.insight ? `<p>${escapeHtml(chart.insight)}</p>` : '';
  const meta = chart.meta || {};
  const metaEntries = Object.entries(meta).filter(([key, value]) => value !== undefined && value !== null && value !== '');
  let metaHtml = '';
  if (metaEntries.length) {
    metaHtml = '<ul class="detail-meta">' + metaEntries.map(([key, value]) => {
      return `<li><span>${escapeHtml(translateMetaKey(key))}:</span>${escapeHtml(formatMetaValue(key, value))}</li>`;
    }).join('') + '</ul>';
  }

  let alertsHtml = '';
  if (chart.id === 'scatter_anomalies' && autoChartState.anomalies && autoChartState.anomalies.length) {
    const items = autoChartState.anomalies.slice(0, 5).map(alert => {
      const message = alert && alert.message ? alert.message : alert;
      return `<li>${escapeHtml(message)}</li>`;
    }).join('');
    alertsHtml = `<div class="analytics-alerts"><strong>–í–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:</strong><ul>${items}</ul></div>`;
  }

  const tableHtml = buildDetailTable(chart);
  detailEl.innerHTML = `
    <div class="detail-header">
      <h4>${escapeHtml(chart.title || '–ì—Ä–∞—Ñ–∏–∫')}</h4>
    </div>
    ${insight}
    ${metaHtml}
    ${alertsHtml}
    ${tableHtml || '<div class="analytics-placeholder"><p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏.</p></div>'}
  `;
}

function buildDetailTable(chart) {
  if (!chart || !chart.chartjs || !chart.chartjs.data) {
    return '';
  }
  const { data } = chart.chartjs;
  const type = chart.type || 'bar';

  if (type === 'scatter' && data.datasets && data.datasets[0] && Array.isArray(data.datasets[0].data)) {
    const dataset = data.datasets[0];
    const rows = [...dataset.data].sort((a, b) => Math.abs((b && b.y) || 0) - Math.abs((a && a.y) || 0)).slice(0, 15);
    if (!rows.length) {
      return '';
    }
    let html = '<table><thead><tr><th>–î–∞—Ç–∞</th><th>–°—É–º–º–∞</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th></tr></thead><tbody>';
    rows.forEach(item => {
      html += `<tr>
        <td>${escapeHtml((item && item.x ? item.x : '‚Äî').toString())}</td>
        <td>${formatCurrency(item && typeof item.y === 'number' ? item.y : 0)}</td>
        <td>${escapeHtml((item && item.category ? item.category : '‚Äî').toString())}</td>
        <td>${escapeHtml((item && item.person ? item.person : '‚Äî').toString())}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    return html;
  }

  const labels = Array.isArray(data.labels) ? data.labels : [];
  const datasets = Array.isArray(data.datasets) ? data.datasets : [];
  if (!labels.length || !datasets.length) {
    return '';
  }

  const maxRows = Math.min(labels.length, 12);
  const headerCells = ['–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å'].concat(datasets.map(ds => escapeHtml(ds.label || '–ó–Ω–∞—á–µ–Ω–∏–µ')));
  let html = '<table><thead><tr>' + headerCells.map(label => `<th>${label}</th>`).join('') + '</tr></thead><tbody>';

  for (let i = 0; i < maxRows; i += 1) {
    const label = labels[i];
    const rowCells = [`<td>${escapeHtml(label != null ? label.toString() : '‚Äî')}</td>`];
    datasets.forEach(ds => {
      const dsData = Array.isArray(ds.data) ? ds.data : [];
      const value = dsData[i];
      if (typeof value === 'number') {
        const useCurrency = /–¥–æ—Ö–æ–¥|—Ä–∞—Å—Ö–æ–¥|—Å—É–º–º|–±–∞–ª–∞–Ω—Å|profit|expense|income/i.test(ds.label || '');
        rowCells.push(`<td>${useCurrency ? formatCurrency(value) : formatNumber(value)}</td>`);
      } else if (value != null) {
        rowCells.push(`<td>${escapeHtml(value.toString())}</td>`);
      } else {
        rowCells.push('<td>‚Äî</td>');
      }
    });
    html += `<tr>${rowCells.join('')}</tr>`;
  }

  html += '</tbody></table>';
  return html;
}

function formatAutoInsightsMessage(payload, anomalyAlerts = []) {
  if (!payload) {
    return '';
  }
  const parts = [];
  parts.push('**–ì–æ—Ç–æ–≤–æ!** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–∞—à–±–æ—Ä–¥ –ø–æ—Å—Ç—Ä–æ–µ–Ω.');
  if (payload.insights && payload.insights.headline) {
    parts.push(payload.insights.headline);
  }
  if (payload.insights && Array.isArray(payload.insights.highlights) && payload.insights.highlights.length) {
    const highlights = payload.insights.highlights.slice(0, 3).map(item => `- ${item}`);
    parts.push(highlights.join('\n'));
  }
  if (anomalyAlerts && anomalyAlerts.length && anomalyAlerts[0]) {
    const alertMessage = anomalyAlerts[0].message || anomalyAlerts[0];
    parts.push(`üö© ${alertMessage}`);
  }
  if (payload.warnings && payload.warnings.length) {
    parts.push(`‚ö†Ô∏è ${payload.warnings[0]}`);
  }
  return parts.join('\n\n');
}

function openCustomChartModal() {
  if (!autoChartState.lastPayload || !autoChartState.lastPayload.ok) {
    alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ñ–∞–π–ª.');
    return;
  }
  populateCustomChartModal(autoChartState.lastPayload);
  const modalEl = document.getElementById('customChartModal');
  if (!modalEl) {
    return;
  }
  autoChartState.modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  autoChartState.modal.show();
}

function populateCustomChartModal(payload) {
  const dimensionSelect = document.getElementById('customChartDimension');
  const metricSelect = document.getElementById('customChartMetric');
  const aggregationSelect = document.getElementById('customChartAggregation');
  const errorEl = document.getElementById('customChartError');
  const saveBtn = document.getElementById('customChartSave');

  if (!dimensionSelect || !metricSelect || !aggregationSelect) {
    return;
  }

  const schema = payload ? payload.schema : null;
  const dimensionOptions = getDimensionOptions(schema);
  const metricOptions = getMetricOptions(schema);

  dimensionSelect.innerHTML = '';
  metricSelect.innerHTML = '';

  dimensionOptions.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt.value;
    option.textContent = opt.label;
    dimensionSelect.appendChild(option);
  });

  metricOptions.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt.value;
    option.textContent = opt.label;
    metricSelect.appendChild(option);
  });

  if (dimensionOptions.length) {
    dimensionSelect.value = dimensionOptions[0].value;
  }
  if (metricOptions.length) {
    metricSelect.value = metricOptions[0].value;
  }
  aggregationSelect.value = 'sum';

  if (errorEl) {
    errorEl.textContent = '';
  }
  if (saveBtn) {
    saveBtn.disabled = !(dimensionOptions.length && metricOptions.length);
  }
  if ((!dimensionOptions.length || !metricOptions.length) && errorEl) {
    errorEl.textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –µ—Å—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ –∏ —á–∏—Å–ª–æ–≤—ã–µ —Å—Ç–æ–ª–±—Ü—ã.';
  }
}

function getDimensionOptions(schema) {
  const options = [];
  const push = (value, label) => {
    if (!value) return;
    if (options.some(opt => opt.value === value)) return;
    options.push({ value, label });
  };
  if (!schema) {
    return options;
  }
  const roles = schema.detected_roles || {};
  if ((roles.category || []).length) push('__category__', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è');
  if ((roles.person || []).length) push('__person__', '–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç');
  if ((roles.account || []).length) push('__account__', '–°—á—ë—Ç');
  if ((roles.tag || []).length) push('__tag__', '–¢–µ–≥–∏');
  if ((roles.date || []).length) push('__date__', '–î–∞—Ç–∞');
  (schema.categorical_columns || []).forEach(col => push(col, col));
  (schema.text_columns || []).slice(0, 5).forEach(col => push(col, col));
  return options;
}

function getMetricOptions(schema) {
  const options = [];
  const push = (value, label) => {
    if (!value) return;
    if (options.some(opt => opt.value === value)) return;
    options.push({ value, label });
  };
  if (!schema) {
    return options;
  }
  push('__expense__', '–†–∞—Å—Ö–æ–¥—ã');
  push('__income__', '–î–æ—Ö–æ–¥—ã');
  push('__amount__', '–ë–∞–ª–∞–Ω—Å');
  push('__balance__', '–û—Å—Ç–∞—Ç–æ–∫');
  (schema.numeric_columns || []).forEach(col => push(col, col));
  return options;
}

async function submitCustomChart() {
  const errorEl = document.getElementById('customChartError');
  const saveBtn = document.getElementById('customChartSave');

  if (!autoChartState.fileId) {
    if (errorEl) {
      errorEl.textContent = '–§–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
    }
    return;
  }

  const payload = {
    file_id: autoChartState.fileId,
    chart_type: document.getElementById('customChartType')?.value || 'bar',
    dimension: document.getElementById('customChartDimension')?.value,
    metric: document.getElementById('customChartMetric')?.value,
    aggregation: document.getElementById('customChartAggregation')?.value || 'sum',
  };

  if (!payload.dimension || !payload.metric) {
    if (errorEl) {
      errorEl.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ –∏ –º–µ—Ç—Ä–∏–∫—É.';
    }
    return;
  }

  if (errorEl) {
    errorEl.textContent = '';
  }
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';
  }

  try {
    const csrftoken = getCookie('csrftoken');
    const resp = await fetch('/api/auto-charts/custom/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
      },
      body: JSON.stringify(payload),
    });
    const data = await resp.json();
    if (!data.ok) {
      throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫');
    }

    const updatedPayload = autoChartState.lastPayload ? { ...autoChartState.lastPayload } : { ok: true, charts: [], primary_chart_ids: [] };
    const chartsList = Array.isArray(updatedPayload.charts) ? [...updatedPayload.charts] : [];
    chartsList.push(data.chart);
    updatedPayload.charts = chartsList;
    if (!updatedPayload.primary_chart_ids) {
      updatedPayload.primary_chart_ids = [];
    }

    renderAutoCharts(updatedPayload, autoChartState.fileId);
    activateChart(data.chart.id);

    if (autoChartState.modal) {
      autoChartState.modal.hide();
    }
  } catch (error) {
    if (errorEl) {
      errorEl.textContent = error.message;
    }
    console.error('Custom chart error', error);
  } finally {
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.textContent = '–ü–æ—Å—Ç—Ä–æ–∏—Ç—å';
    }
  }
}

function escapeHtml(text) {
  return String(text || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function translateMetaKey(key) {
  const map = {
    frequency: '–ü–µ—Ä–∏–æ–¥',
    records: '–ó–∞–ø–∏—Å–µ–π',
    anomalies: '–ê–Ω–æ–º–∞–ª–∏–π',
    aggregation: '–ê–≥—Ä–µ–≥–∞—Ü–∏—è',
    source: '–ò—Å—Ç–æ—á–Ω–∏–∫',
  };
  return map[key] || key;
}

function formatMetaValue(key, value) {
  if (value === null || value === undefined) {
    return '‚Äî';
  }
  if (key === 'frequency') {
    const freqMap = { M: '–ú–µ—Å—è—Ü', W: '–ù–µ–¥–µ–ª—è', D: '–î–µ–Ω—å', Q: '–ö–≤–∞—Ä—Ç–∞–ª' };
    return freqMap[value] || value;
  }
  if (key === 'aggregation') {
    const aggMap = { sum: '–°—É–º–º–∞', avg: '–°—Ä–µ–¥–Ω–µ–µ', count: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ' };
    return aggMap[value] || value;
  }
  if (key === 'source') {
    const sourceMap = { custom: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', auto: '–ê–≤—Ç–æ', default: '–°–∏—Å—Ç–µ–º–∞' };
    return sourceMap[value] || value;
  }
  if (typeof value === 'number') {
    return formatNumber(value);
  }
  return value.toString();
}

function formatNumber(value) {
  const num = Number(value);
  if (!Number.isFinite(num)) {
    return value != null ? value.toString() : '0';
  }
  return num.toLocaleString('ru-RU');
}

async function openChat(id) {
  try {
    const resp = await fetch(`/api/chat/sessions/${id}/`);
    const data = await resp.json();
    if (!data.ok) return;
    // Set active session
    sessionId = data.session.session_id;
    localStorage.setItem('chatSessionId', sessionId);
    // Render messages
    const box = document.getElementById('chatMessages');
    box.innerHTML = '';
    (data.messages || []).forEach(m => addMessage(m.role, m.content));
    // Refresh sidebar highlighting
    loadChatSessions();
  } catch (e) { /* noop */ }
}

function newChat() {
  // Start a new chat session lazily (server creates on first send)
  sessionId = null;
  localStorage.removeItem('chatSessionId');
  document.getElementById('chatMessages').innerHTML = '';
  addMessage('assistant', '–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —á–∞—Ç. –ß–µ–º –ø–æ–º–æ—á—å?');
}

async function renameChat() {
  if (!sessionId) { alert('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç.'); return; }
  const title = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:');
  if (!title) return;
  const csrftoken = getCookie('csrftoken');
  const resp = await fetch(`/api/chat/sessions/${sessionId}/rename/`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }, body: JSON.stringify({ title }) });
  const data = await resp.json();
  if (data.ok) loadChatSessions();
}

async function deleteChat() {
  if (!sessionId) { alert('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç.'); return; }
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é?')) return;
  const csrftoken = getCookie('csrftoken');
  const resp = await fetch(`/api/chat/sessions/${sessionId}/delete/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken } });
  const data = await resp.json();
  if (data.ok) {
    sessionId = null; localStorage.removeItem('chatSessionId');
    document.getElementById('chatMessages').innerHTML = '';
    loadChatSessions();
  }
}

async function openCompareDialog() {
  // Minimal prompt-based UI
  const aStart = prompt('–ü–µ—Ä–∏–æ–¥ A - —Å—Ç–∞—Ä—Ç (YYYY-MM-DD):');
  const aEnd = prompt('–ü–µ—Ä–∏–æ–¥ A - –∫–æ–Ω–µ—Ü (YYYY-MM-DD):');
  const bStart = prompt('–ü–µ—Ä–∏–æ–¥ B - —Å—Ç–∞—Ä—Ç (YYYY-MM-DD):');
  const bEnd = prompt('–ü–µ—Ä–∏–æ–¥ B - –∫–æ–Ω–µ—Ü (YYYY-MM-DD):');
  if (!aStart || !aEnd || !bStart || !bEnd) return;
  const csrftoken = getCookie('csrftoken');
  const resp = await fetch('/api/chat/compare/', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }, body: JSON.stringify({ items: [ { label: '–ü–µ—Ä–∏–æ–¥ A', start: aStart, end: aEnd }, { label: '–ü–µ—Ä–∏–æ–¥ B', start: bStart, end: bEnd } ] }) });
  const data = await resp.json();
  if (data.ok) {
    renderComparisonCharts(data.results || []);
  }
}

function renderComparisonCharts(results) {
  const container = document.getElementById('chartsContainer');
  container.innerHTML = '';
  results.forEach((r, idx) => {
    const wrap = document.createElement('div');
    wrap.className = 'chart-container';
    wrap.innerHTML = `<h4 style="margin-top:0;">${r.label}: ${r.start || ''} ‚Äî ${r.end || ''}</h4><canvas id="cmp_${idx}"></canvas>`;
    container.appendChild(wrap);
    const ctx = document.getElementById(`cmp_${idx}`).getContext('2d');
    const months = Array.from(new Set([...Object.keys(r.income_by_month||{}), ...Object.keys(r.expense_by_month||{})])).sort();
    const income = months.map(m => r.income_by_month?.[m] || 0);
    const expense = months.map(m => r.expense_by_month?.[m] || 0);
    new Chart(ctx, { type: 'bar', data: { labels: months, datasets: [ { label: '–î–æ—Ö–æ–¥—ã', data: income, backgroundColor: '#10b981' }, { label: '–†–∞—Å—Ö–æ–¥—ã', data: expense, backgroundColor: '#ef4444' } ] }, options: { responsive: true, plugins: { legend: { position: 'bottom' } } } });
  });
}

// Chat functionality
function initChat() {
  const chatInput = document.getElementById('chatInput');
  const sendButton = document.getElementById('sendButton');
  const clearChat = document.getElementById('clearChat');
  
  // Auto-resize textarea
  chatInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 200) + 'px';
  });
  
  // Send on Enter (Shift+Enter for new line)
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  sendButton.addEventListener('click', sendMessage);
  clearChat.addEventListener('click', () => {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?')) {
      sessionId = null;
      localStorage.removeItem('chatSessionId');
      document.getElementById('chatMessages').innerHTML = '';
      addMessage('assistant', '–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞. –ö–∞–∫ —è –º–æ–≥—É –ø–æ–º–æ—á—å?');
    }
  });
  const btnUpload = document.getElementById('btnUpload');
  // File upload button (in input container)
  const fileUploadBtn = document.getElementById('fileUploadBtn');
  const fileInput = document.getElementById('fileInput');
  if (fileUploadBtn && fileInput) {
    fileUploadBtn.addEventListener('click', () => {
      fileInput.click();
    });
    fileInput.addEventListener('change', async (e) => {
      if (e.target.files && e.target.files[0]) {
        await handleFile(e.target.files[0]);
        e.target.value = '';
      }
    });
  }
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message) return;
  
  // Add user message
  addMessage('user', message);
  input.value = '';
  input.style.height = 'auto';
  
  // Show loading
  const loadingId = addMessage('assistant', '...', true);
  
  try {
    const willUseLocal = false;
    const anonymize = true;
    const selectedModel = 'openai/gpt-4o-mini';

    if (!willUseLocal && !anonymize) {
      const proceed = confirm('–í–Ω–∏–º–∞–Ω–∏–µ: –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –æ–±–ª–∞–∫–æ –±–µ–∑ –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?');
      if (!proceed) { removeMessage(loadingId); return; }
    }

    // JSON body + encrypted fetch wrapper
    const csrftoken = getCookie('csrftoken');
    const response = await fetch('/ai/chat/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message,
        session_id: sessionId,
        use_local: willUseLocal || selectedModel.startsWith('ollama/'),
        anonymize,
      })
    });
    
    const data = await response.json();
    
    if (data.ok) {
      // Update session ID
      if (data.session_id) {
        sessionId = data.session_id;
        localStorage.setItem('chatSessionId', sessionId);
      }
      
      // Remove loading, add response
      removeMessage(loadingId);
      addMessage('assistant', data.reply);
      
      // Visuals are rendered in chat by AI output now
    } else {
      removeMessage(loadingId);
      addMessage('assistant', `–û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
    }
  } catch (error) {
    removeMessage(loadingId);
    addMessage('assistant', `–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}`);
  }
}

function addMessage(role, content, isLoading = false) {
  const messagesContainer = document.getElementById('chatMessages');
  const messageId = 'msg-' + Date.now();
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${role}`;
  messageDiv.id = messageId;
  
  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  avatar.textContent = role === 'user' ? '' : 'ü§ñ';
  
  const contentDiv = document.createElement('div');
  contentDiv.className = 'message-content';
  
  if (isLoading) {
    contentDiv.innerHTML = '<div class="loading"></div>';
  } else {
    // Render markdown
    if (role === 'assistant') {
      contentDiv.innerHTML = marked.parse(content);
      // Highlight code blocks
      contentDiv.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
      });
    } else {
      contentDiv.textContent = content;
    }
  }
  
  messageDiv.appendChild(avatar);
  messageDiv.appendChild(contentDiv);
  messagesContainer.appendChild(messageDiv);
  
  // Scroll to bottom
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  return messageId;
}

function removeMessage(messageId) {
  const msg = document.getElementById(messageId);
  if (msg) msg.remove();
}

function initUploadModal() {
  const input = document.getElementById('fileInput');
  const btn = document.getElementById('uploadConfirm');
  btn.addEventListener('click', async () => {
    if (!input.files || !input.files[0]) return;
    await handleFile(input.files[0]);
    const modalEl = document.getElementById('uploadModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal?.hide();
    input.value = '';
  });
}

async function handleFile(file) {
  try {
    const formData = new FormData();
    formData.append('upload_file', file);
    formData.append('import_to_db', 'on');
    if (sessionId) formData.append('session_id', sessionId);
    
    const csrftoken = getCookie('csrftoken');
    const response = await fetch('/api/upload/', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': csrftoken
      }
    });
    
    const data = await response.json();
    
    if (!data.ok) {
      addMessage('assistant', `–û—à–∏–±–∫–∞: ${data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª.'}`);
      return;
    }

    const chartsPayload = data.auto_charts || null;
    const fileIdForCharts = chartsPayload && chartsPayload.ok && data.file ? data.file.id : null;
    autoChartState.anomalies = data.anomaly_alerts || [];
    renderAutoCharts(chartsPayload, fileIdForCharts);

    if (chartsPayload && chartsPayload.ok) {
      const summaryMessage = formatAutoInsightsMessage(chartsPayload, data.anomaly_alerts || []);
      if (summaryMessage) {
        addMessage('assistant', summaryMessage);
      }
    } else {
      addMessage('assistant', '–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω. –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–ª–æ–Ω–æ–∫.');
    }

    if (data.ai_advice) {
      addMessage('assistant', data.ai_advice);
    }
  } catch (error) {
    console.error('File upload error', error);
    addMessage('assistant', `–û—à–∏–±–∫–∞: ${error.message}`);
  }
}

// Removed workspace stats/charts; visuals should be provided by AI responses

function formatCurrency(value) {
  return new Intl.NumberFormat('ru-RU', {
    style: 'currency',
    currency: 'RUB',
    minimumFractionDigits: 0
  }).format(value);
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// ==========================
// User settings (simplified)
// ==========================
async function loadUserSettings() {
  try {
    const resp = await fetch('/api/user/settings/');
    const s = await resp.json();
  } catch (e) { /* noop */ }
}

async function saveUserSettings() { /* simplified */ }

// Export all data as encrypted file (.sbenc)
async function exportEncryptedAll() { /* removed from minimal UI */ }

// Delete all user data
async function deleteAllData() {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è?')) return;
  try {
    const csrftoken = getCookie('csrftoken');
    const resp = await fetch('/api/delete-all/', { method: 'POST', headers: { 'X-CSRFToken': csrftoken } });
    const data = await resp.json();
    if (data.ok) {
      alert('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã.');
      document.getElementById('chatMessages').innerHTML = '';
    } else {
      alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (data.error || '')); 
    }
  } catch (e) {
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + e.message);
  }
}
</script>
{% endblock %}

